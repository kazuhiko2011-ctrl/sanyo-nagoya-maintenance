
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>チェックリストアプリ</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container mt-5">
        <!-- ... HTML structure ... -->
        <div id="checklist-app-container" class="d-none">
            <h1 id="checklist-title" class="text-center mb-4"></h1>
            <div id="checklist-container"></div>
            <div class="mt-3 text-center">
                <button id="prev-btn" class="btn btn-secondary">戻る</button>
                <button id="next-btn" class="btn btn-primary">次へ</button>
                <button id="print-btn" class="btn btn-info" disabled>結果を印刷/PDF化</button>
                <button id="exit-btn" class="btn btn-danger">終了</button>
            </div>
        </div>
    </div>
    <div id="printable-area" class="d-none"></div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
(function() {
    // ... (previous code like SECRET_KEY, getQueryParam, access check, initMenu, etc.) ...

    function updateNavigation() {
        var totalPhases = Math.max.apply(Math, checklistData.map(function(item) { return parseInt(item.phase); }));
        $('#prev-btn').toggle(currentPhase > 1);
        $('#next-btn').toggle(currentPhase < totalPhases);

        var phaseItems = checklistData.filter(function(item) { return parseInt(item.phase) === currentPhase; });
        var itemsToCheck = phaseItems;
        
        if (currentPhase === 3 || currentPhase === 5) {
            var linkedPhase = currentPhase === 3 ? 2 : 4;
            var problemItemIds = [];
            for (var key in userSelections) {
                if (userSelections.hasOwnProperty(key)) {
                    var selection = userSelections[key];
                    if (parseInt(key.split('_')[0]) === linkedPhase && selection.value === '問題あり') {
                        problemItemIds.push(key);
                    }
                }
            }
            itemsToCheck = phaseItems.filter(function(item) { return problemItemIds.indexOf(item.linked_item_id) !== -1; });

            // --- DEBUGGING CODE --- 
            if (currentPhase === 5) {
                console.log('--- Phase 5 Debugging ---');
                console.log('All user selections:', JSON.parse(JSON.stringify(userSelections)));
                console.log('Looking for problems from phase:', linkedPhase);
                console.log('Found problem item IDs from Phase 4:', problemItemIds);
                console.log('Visible items for Phase 5 (itemsToCheck):', itemsToCheck);
            }
            // --- END DEBUGGING CODE ---
        }

        var isNextEnabled = false;
        if (currentPhase === 1) {
            var detectionItems = itemsToCheck.filter(function(item) { return item.category === '異常検知'; });
            var stopItems = itemsToCheck.filter(function(item) { return item.category === '緊急停止措置'; });
            var oneDetectionChecked = detectionItems.some(function(item) { return userSelections[item.item_id]; });
            var allStopsChecked = stopItems.every(function(item) { return userSelections[item.item_id]; });
            isNextEnabled = oneDetectionChecked && allStopsChecked;
        } else {
            isNextEnabled = itemsToCheck.length > 0 ? itemsToCheck.every(function(item) { return userSelections[item.item_id]; }) : true;
        }
        
        // --- DEBUGGING CODE --- 
        if (currentPhase === 5) {
            console.log('Are all visible items answered?', itemsToCheck.every(function(item) { return userSelections[item.item_id]; }));
            console.log('Is Next button enabled?', isNextEnabled);
            console.log('--------------------------');
        }
        // --- END DEBUGGING CODE ---

        $('#next-btn').prop('disabled', !isNextEnabled);

        // ... (rest of the function for print button, etc.) ...
    }

    // ... (the rest of the entire script) ...
})();
    </script>
</body>
</html>
