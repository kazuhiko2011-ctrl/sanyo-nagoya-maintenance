<!DOCTYPE html>
<html lang="ja">
<head>

<!-- アクセス制限＆リンク修正用スクリプト -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    try {
      const SECRET_KEY = "93SYa4oyAeTbhKaC1Cj3hA";
      const params = new URLSearchParams(window.location.search);
      const currentKey = params.get('key');

      if (currentKey === SECRET_KEY) {
        // --- アクセス許可 ---
        // ページ内の全リンクを調べて、キーを付与する
        const links = document.querySelectorAll('a');
        links.forEach(link => {
          const href = link.getAttribute('href');
          // ローカルのHTMLファイルへのリンクかチェック (相対パスを想定)
          if (href && href.endsWith('.html') && !href.startsWith('http')) {
            link.href = href + '?key=' + currentKey;
          }
        });
      } else {
        // --- アクセス拒否 ---
        document.body.style.visibility = 'hidden';
        document.body.innerHTML = '<div style="text-align: center; padding-top: 50px; font-family: sans-serif;"><h1>アクセス権がありません</h1><p>このページは指定された場所からのみアクセスできます。</p></div>';
        document.body.style.visibility = 'visible';
        throw new Error("Invalid or missing access key.");
      }
    } catch (e) {
      // エラー発生時も念のため拒否
      document.body.style.visibility = 'hidden';
      document.body.innerHTML = '<div style="text-align: center; padding-top: 50px; font-family: sans-serif;"><h1>アクセス権がありません</h1><p>このページは指定された場所からのみアクセスできます。</p></div>';
      document.body.style.visibility = 'visible';
      throw new Error("Access denied due to an error during key check.");
    }
  });
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>紙袋充填機チェックリスト</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">紙袋充填機チェックリスト</h1>
        <div id="checklist-container"></div>
        <div class="mt-3 text-center">
            <button id="prev-btn" class="btn btn-secondary">戻る</button>
            <button id="next-btn" class="btn btn-primary">次へ</button>
            <button id="print-btn" class="btn btn-info">結果を印刷/PDF化</button>
            <button id="exit-btn" class="btn btn-danger">終了</button>
        </div>
    </div>
    <div id="printable-area"></div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
$(document).ready(function() {
    console.log("スクリプト開始");

    const csvData = `phase,phase_title,type,category,item,item_id,linked_item_id
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,袋が供給されない（給袋ミス）、または複数枚同時に供給される（二枚取り）,1_0,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,充填重量が設定値から大きく外れる、または計量値が安定しない（バラツキ大）,1_1,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,【ミシン】 糸が頻繁に切れる、縫い目が飛ぶ（目飛び）、または糸が絡まる（鳥の巣発生）,1_2,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,【ミシン】 縫い目のピッチが不均一、蛇行する、またはクレープ紙テープが外れる,1_3,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,【ヒートシール】 シール部分の接着が弱い・剥がれる（シール不良）、または異物が混入する（噛み込み）,1_4,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,【ヒートシール】 シール部分が溶けすぎる、シワになる、または穴が開く（オーバーシール）,1_5,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,袋が搬送中に倒れる、または所定の位置からズレる,1_6,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,機械から異音（金属音、打音、きしみ音）、異臭（焦げ臭い匂い、電気的な匂い）、異常な振動が発生する,1_7,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,操作パネルにエラーコードや「モーター過負荷」「センサー未検出」等の警告が表示されている,1_8,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,その他,1_9,
1,"Phase 1: 異常検知・緊急停止",checklist,緊急停止措置,直ちに「非常停止ボタン」を押し、機械を停止させる,1_10,
1,"Phase 1: 異常検知・緊急停止",checklist,緊急停止措置,メンテナンス時は、必ず主電源ブレーカーを「OFF」にし、「操作禁止/作業中」の札を掲示する（ロックアウト/タグアウト）,1_11,
1,"Phase 1: 異常検知・緊急停止",checklist,緊急停止措置,責任者およびメンテナンス部門に、発生状況、エラー内容、発生箇所を正確に報告する,1_12,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,資材確認,紙袋が湿気ている、反っている、または折れている,2_0,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,資材確認,ミシン糸の糸道が間違っている、またはテープが正しくセットされていない,2_1,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,外観・目視点検,吸着パッド、センサーレンズ、シールバー表面に汚れや粉塵が付着している,2_2,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,外観・目視点検,ミシン針が曲がっている、または先端が摩耗している,2_3,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,操作パネル確認,エラー履歴に具体的なエラーコードが表示されている,2_4,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,操作パネル確認,ヒーター温度や各種設定値が、基準値から変更されている,2_5,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,空圧系統確認,エアゲージ（圧力計）の圧力が規定値より低い、または高すぎる,2_6,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,空圧系統確認,エアーフィルターのケースに、水分（ドレン）や油分が溜まっている,2_7,
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,資材確認,乾燥した正常な紙袋に交換する,3_0,2_0
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,資材確認,ミシン糸を正しい糸道にかけ直し、テープを正しくセットし直す,3_1,2_1
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,外観・目視点検,付着した汚れや粉塵を、ウエスやエアブローで清掃する,3_2,2_2
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,外観・目視点検,摩耗したミシン針を新品に交換する,3_3,2_3
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,操作パネル確認,表示されたエラーコードに基づき、マニュアルで指定されたリセット操作を行う,3_4,2_4
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,操作パネル確認,誤った設定値を正しい基準値に修正する,3_5,2_5
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,空圧系統確認,元圧を確認し、レギュレーターで規定の圧力に再設定する,3_6,2_6
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,空圧系統確認,エアーフィルターのドレンを排出し、ケース内を清掃する,3_7,2_7
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,給袋・開袋ユニット,吸着パッドの真空圧力が規定値に達していない。真空エジェクタのフィルターが詰まっている,4_0,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,計量・充填ユニット,ロードセルストッパーの隙間が不適正、または周辺に配線などが干渉している,4_1,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,ミシンユニット,針とルーパーの隙間（クリアランス）やタイミングがズレている。部品が摩耗している,4_2,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,ヒートシーラーユニット,テスター測定でヒーターが断線している、または絶縁不良を起こしている,4_3,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,ヒートシーラーユニット,温度センサー（熱電対）の取付不良、または断線している,4_4,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,駆動・伝達系統,タイミングベルトやチェーンの張り（テンション）が緩んでいる、または張りすぎている,4_5,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,駆動・伝達系統,モーターや減速機に過熱や異音が発生している,4_6,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,電気・制御系統,PLCモニタで特定のセンサーや電磁弁の信号が入出力されていない,4_7,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,電気・制御系統,インバーターや制御盤内のリレー、接触器に異常が見られる,4_8,
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,給袋・開袋ユニット,真空ポンプ/エジェクタを点検・調整する。フィルターを清掃または交換する,,4_0
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,計量・充填ユニット,ストッパーの隙間を規定値に調整し、干渉物を除去後、キャリブレーション（ゼロ点・スパン調整）を行う,,4_1
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,ミシンユニット,針、ルーパー、押さえ金、送り歯の各クリアランスとタイミングを規定値に再調整する。摩耗部品を交換する,,4_2
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,ヒートシーラーユニット,断線したヒーターを交換し、絶縁不良箇所を修理する,,4_3
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,ヒートシーラーユニット,故障した温度センサーを交換し、正しく設置する。配線の緩みを締め直す,,4_4
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,駆動・伝達系統,ベルトやチェーンのテンションを規定の張力に再調整する,,4_5
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,駆動・伝達系統,異音・過熱の原因（潤滑不足、ベアリング摩耗等）を特定し、給油または部品交換を行う,,4_6
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,電気・制御系統,故障したセンサー、電磁弁を特定し交換する,,4_7
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,電気・制御系統,故障したインバーター、リレー、接触器を交換し、必要に応じてパラメータを再設定する,,4_8
6,"Phase 4: 再起動前準備",checklist_with_status,復旧確認,交換した部品や使用した工具類が、機械内部や周辺に残置されていないか最終確認する,6_0,
6,"Phase 4: 再起動前準備",checklist_with_status,復旧確認,調整・交換した箇所のボルトやネジが、確実に締め付けられているか確認する,6_1,
6,"Phase 4: 再起動前準備",checklist_with_status,安全確認,全ての安全カバーや扉が、正しく取り付けられ、インターロックスイッチが正常に機能することを確認する,6_2,
6,"Phase 4: 再起動前準備",checklist_with_status,安全確認,周囲に他の作業者がいないことを確認し、再起動することを声に出して明確に周知する,6_3,
6,"Phase 4: 再起動前準備",checklist_with_status,電源投入,主電源ブレーカーおよび操作パネルの電源を「ON」にする,6_4,
6,"Phase 4: 再起動前準備",checklist_with_status,初期化・リセット,操作パネルでエラー履歴をリセットし、機械の「原点復帰」操作を行う,6_5,
6,"Phase 4: 再起動前準備",checklist_with_status,状態記録,対応内容（交換部品、調整箇所、調整値など）を設備台帳や作業日報に記録する,6_6,
7,"Phase 5: 試運転・正規運転",checklist_with_status,寸動・手動運転,手動モードで各ユニットを個別に最低速度で動かし、干渉や異音、異常な動作がないか確認する,7_0,
7,"Phase 5: 試運転・正規運転",checklist_with_status,空袋での試運転,空の紙袋を数サイクル流し、供給から搬送、袋口処理まで一連の動作タイミングがスムーズか確認する,7_1,
7,"Phase 5: 試運転・正規運転",checklist_with_status,実充填での試運転,実際に原料を投入し、低速で運転を開始する。異常があれば即時停止する,7_2,
7,"Phase 5: 試運転・正規運転",checklist_with_status,品質確認（初期）,最初の5～10袋の充填重量を個別に測定し、規定重量の範囲内で安定しているか確認する,7_3,
7,"Phase 5: 試運転・正規運転",checklist_with_status,品質確認（初期）,【ミシン】 縫い目のピッチ、強度、見た目を確認。目飛びや糸切れがないか入念にチェックする,7_4,
7,"Phase 5: 試運転・正規運転",checklist_with_status,品質確認（初期）,【ヒートシール】 シール部分を実際に手で剥がし、均一な強度で接着されているか（破断テスト）、見た目に異常がないか確認する,7_5,
7,"Phase 5: 試運転・正規運転",checklist_with_status,段階的な速度上昇,品質に問題がなければ、生産速度を段階的に（例：50%→80%→100%）上げ、各段階で異音や振動、品質に変化がないか監視する,7_6,
7,"Phase 5: 試運転・正規運転",checklist_with_status,正規運転・監視,正規運転開始後も、定期的に（例：30分～1時間に1回）製品を抜き取り、充填重量、縫い目、シール状態を確認し、記録する,7_7,
`;

    let checklistData = [];
    let currentPhase = 1;
    let totalPhases = 0;
    let userSelections = {};
    const fileNameForStorage = "Paper_Bag_Filling_Machine_Checklist.html";

    const selectionKey = `userSelections_${fileNameForStorage}`;
    const phaseKey = `currentPhase_${fileNameForStorage}`;

    function initialize() {
        console.log("1. 初期化開始");
        try {
            const parsed = Papa.parse(csvData, { header: true, skipEmptyLines: true });
            checklistData = parsed.data;
            console.log("2. CSVデータ解析完了", checklistData);

            if (!checklistData || checklistData.length === 0) {
                console.error("エラー: checklistDataが空です。");
                $('#checklist-container').text("エラー: チェックリストデータが空か、不正な形式です。");
                return;
            }

            if (sessionStorage.getItem(selectionKey)) {
                userSelections = JSON.parse(sessionStorage.getItem(selectionKey));
            }
            if (sessionStorage.getItem(phaseKey)) {
                currentPhase = parseInt(sessionStorage.getItem(phaseKey));
            }
            console.log("3. sessionStorage読み込み完了", { userSelections, currentPhase });

            totalPhases = Math.max(...checklistData.map(item => parseInt(item.phase)));
            renderPhase(currentPhase);
        } catch (e) {
            console.error("初期化中にエラーが発生しました:", e);
            $('#checklist-container').text("エラー: アプリケーションの初期化に失敗しました。");
        }
    }

    function renderPhase(phase) {
        console.log(`4. Phase ${phase} のレンダリング開始`);
        let container = $('#checklist-container');
        container.empty();

        const phaseData = checklistData.filter(item => parseInt(item.phase) === phase);
        if (phaseData.length === 0) {
            console.log(`Phase ${phase} には項目がありません。`);
            if (phase <= totalPhases) {
                container.append('<p>このフェーズで表示する項目はありません。次へ進んでください。</p>');
            } else {
                container.append('<p>チェックリスト完了です。</p>');
            }
            updateNavigation();
            updateNextButtonState();
            return;
        }

        const phaseTitle = phaseData[0].phase_title;
        container.append(`<h2 class="phase-title">${phaseTitle}</h2>`);
        console.log(`5. Phaseタイトル '${phaseTitle}' を表示`);

        let itemsToShow = phaseData;
        if (phase === 3 || phase === 5) {
            const linkedPhaseNumber = phase === 3 ? 2 : 4;
            const problemItemIds = Object.values(userSelections)
                .filter(sel => sel.phase === linkedPhaseNumber && sel.value === '問題あり')
                .map(sel => sel.id);
            
            console.log(`Phase ${linkedPhaseNumber} からの問題項目ID:`, problemItemIds);
            itemsToShow = phaseData.filter(item => problemItemIds.includes(item.linked_item_id));

            if (itemsToShow.length === 0) {
                container.append('<p>前のフェーズで「問題あり」とされた項目はありません。次へ進んでください。</p>');
            }
        }

        if (itemsToShow.length > 0) {
            renderItems(itemsToShow, phase);
        }
        
        updateNavigation();
        updateNextButtonState();
    }
    
    function renderItems(items, phase) {
        const groupedByCategory = items.reduce((acc, item) => {
            (acc[item.category] = acc[item.category] || []).push(item);
            return acc;
        }, {});

        for (const category in groupedByCategory) {
            $('#checklist-container').append(`<h4 class="category-title">${category}</h4>`);
            const itemsInCategory = groupedByCategory[category];
            itemsInCategory.forEach(item => {
                const itemKey = item.item_id;
                const savedValue = userSelections[itemKey] ? userSelections[itemKey].value : undefined;
                let inputs = '';

                if (item.type === 'checklist') {
                    const isChecked = savedValue === 'checked';
                    inputs = `<input type="checkbox" class="form-check-input" data-item-key="${itemKey}" ${isChecked ? 'checked' : ''}>`;
                } else {
                    if (phase === 2 || phase === 4) {
                        const isOK = savedValue === '問題なし';
                        const isNG = savedValue === '問題あり';
                        inputs = `
                            <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                <label class="btn btn-outline-success ${isOK ? 'active' : ''}"><input type="radio" name="${itemKey}" value="問題なし" ${isOK ? 'checked' : ''}> 問題なし</label>
                                <label class="btn btn-outline-danger ${isNG ? 'active' : ''}"><input type="radio" name="${itemKey}" value="問題あり" ${isNG ? 'checked' : ''}> 問題あり</label>
                            </div>`;
                    } else {
                         const isDone = savedValue === '実施済み';
                         const isNA = savedValue === '非該当';
                         inputs = `
                             <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                 <label class="btn btn-outline-primary ${isDone ? 'active' : ''}"><input type="radio" name="${itemKey}" value="実施済み" ${isDone ? 'checked' : ''}> 実施済み</label>
                                 <label class="btn btn-outline-secondary ${isNA ? 'active' : ''}"><input type="radio" name="${itemKey}" value="非該当" ${isNA ? 'checked' : ''}> 非該当</label>
                             </div>`;
                    }
                }
                $('#checklist-container').append(`<div class="checklist-item-row"><label class="item-label">${item.item}</label><div>${inputs}</div></div>`);
            });
        }
        console.log("6. 全項目のレンダリング完了");
    }

    function updateNavigation() {
        $('#prev-btn').toggle(currentPhase > 1);
        $('#next-btn').toggle(currentPhase < totalPhases);
        $('#print-btn').toggle(currentPhase >= 3);
    }

    function updateNextButtonState() {
        let enabled = false;
        const phaseData = checklistData.filter(item => parseInt(item.phase) === currentPhase);

        if (phaseData.length === 0) {
            enabled = true; // Enable if there are no items in the phase
        } else if (currentPhase === 1) {
            const emergencyItems = phaseData.filter(i => i.category === '緊急停止措置');
            const detectionItems = phaseData.filter(i => i.category === '異常検知');
            
            // All emergency items must be checked
            const emergencyAllChecked = emergencyItems.every(item => userSelections[item.item_id] && userSelections[item.item_id].value === 'checked');
            // At least one detection item must be checked
            const detectionOneChecked = detectionItems.some(item => userSelections[item.item_id] && userSelections[item.item_id].value === 'checked');
            
            enabled = emergencyAllChecked && detectionOneChecked;
        } else {
            let itemsToCheck = phaseData;
            if (currentPhase === 3 || currentPhase === 5) {
                const linkedPhaseNumber = currentPhase === 3 ? 2 : 4;
                const problemItemIds = Object.values(userSelections)
                    .filter(sel => sel.phase === linkedPhaseNumber && sel.value === '問題あり')
                    .map(sel => sel.id);
                itemsToCheck = itemsToCheck.filter(item => problemItemIds.includes(item.linked_item_id));
            }
            
            if (itemsToCheck.length === 0) {
                enabled = true;
            } else {
                enabled = itemsToCheck.every(item => userSelections[item.item_id]);
            }
        }
        $('#next-btn').prop('disabled', !enabled);
    }

    $('#checklist-container').on('change', 'input', function() {
        const key = $(this).attr('name') || $(this).data('item-key');
        const value = $(this).is(':checkbox') ? ($(this).is(':checked') ? 'checked' : 'unchecked') : $(this).val();
        
        userSelections[key] = { value: value, id: key, phase: currentPhase };
        sessionStorage.setItem(selectionKey, JSON.stringify(userSelections));
        updateNextButtonState();
    });

    $('#next-btn').click(function() {
        if (currentPhase < totalPhases) {
            currentPhase++;
            sessionStorage.setItem(phaseKey, currentPhase);
            renderPhase(currentPhase);
        }
    });

    $('#prev-btn').click(function() {
        if (currentPhase > 1) {
            currentPhase--;
            sessionStorage.setItem(phaseKey, currentPhase);
            renderPhase(currentPhase);
        }
    });

    $('#exit-btn').click(function() {
        if (confirm('メインメニューに戻りますか？\n(入力内容は保存されます)')) {
            window.location.href = 'index.html';
        }
    });

    $('#print-btn').click(function() {
        const checklistTitle = "紙袋充填機チェックリスト";

        let summaryHtml = `<div style="padding: 20px; font-family: sans-serif;"><h1>${checklistTitle} - 実施報告書</h1><p><strong>実施日:</strong> ${new Date().toLocaleDateString()}</p><hr>`;

        // Phase 1
        summaryHtml += '<h3>Phase 1: 異常検知・緊急停止の状況</h3>';
        const phase1_detection = checklistData.filter(item => parseInt(item.phase) === 1 && item.category === '異常検知');
        const phase1_stop = checklistData.filter(item => parseInt(item.phase) === 1 && item.category === '緊急停止措置');
        summaryHtml += '<h4>異常検知</h4><ul>';
        let detectionChecked = false;
        phase1_detection.forEach(item => {
            if (userSelections[item.item_id] && userSelections[item.item_id].value === 'checked') {
                summaryHtml += `<li>${item.item}</li>`;
                detectionChecked = true;
            }
        });
        if (!detectionChecked) summaryHtml += '<li>検知された異常はありません。</li>';
        summaryHtml += '</ul><h4>緊急停止措置</h4><ul>';
        phase1_stop.forEach(item => {
            const status = (userSelections[item.item_id] && userSelections[item.item_id].value === 'checked') ? '実施' : '未実施';
            summaryHtml += `<li>${item.item}: <strong>${status}</strong></li>`;
        });
        summaryHtml += '</ul><hr>';

        // Phase 2-1
        summaryHtml += '<h3>Phase 2-1: 故障原因調査（使用部門）</h3><ul>';
        const phase2Data = checklistData.filter(item => parseInt(item.phase) === 2);
        let causeInvestigated = false;
        phase2Data.forEach(item => {
            if (userSelections[item.item_id]) {
                summaryHtml += `<li>${item.item}: <strong>${userSelections[item.item_id].value}</strong></li>`;
                causeInvestigated = true;
            }
        });
        if (!causeInvestigated) summaryHtml += '<li>故障原因調査の項目はありません。</li>';
        summaryHtml += '</ul><hr>';

        // Phase 3-1 (Corrected Logic)
        summaryHtml += '<h3>Phase 3-1: 対策実施（使用部門）</h3><ul>';
        const problemItemIdsFromPhase2 = Object.values(userSelections)
            .filter(sel => sel.phase === 2 && sel.value === '問題あり')
            .map(sel => sel.id);
        const phase3ItemsToShow = checklistData.filter(item => 
            parseInt(item.phase) === 3 && problemItemIdsFromPhase2.includes(item.linked_item_id)
        );

        let measuresTaken = false;
        phase3ItemsToShow.forEach(item => {
            if (userSelections[item.item_id]) {
                summaryHtml += `<li>${item.item}: <strong>${userSelections[item.item_id].value}</strong></li>`;
                measuresTaken = true;
            }
        });

        if (!measuresTaken) {
            if (phase3ItemsToShow.length > 0) {
                 summaryHtml += '<li>選択された対策項目はありません。</li>';
            } else {
                 summaryHtml += '<li>前のフェーズで「問題あり」とされた項目がなかったため、対策項目はありません。</li>';
            }
        }
        summaryHtml += '</ul></div>';

        $('#printable-area').html(summaryHtml);
        window.print();
    });
    
    initialize();
});
    </script>
</body>
</html>