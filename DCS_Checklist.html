<!DOCTYPE html>
<html lang="ja">
<head>

<!-- アクセス制限＆リンク修正用スクリプト -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    try {
      const SECRET_KEY = "93SYa4oyAeTbhKaC1Cj3hA";
      const params = new URLSearchParams(window.location.search);
      const currentKey = params.get('key');

      if (currentKey === SECRET_KEY) {
        // --- アクセス許可 ---
        // ページ内の全リンクを調べて、キーを付与する
        const links = document.querySelectorAll('a');
        links.forEach(link => {
          const href = link.getAttribute('href');
          // ローカルのHTMLファイルへのリンクかチェック (相対パスを想定)
          if (href && href.endsWith('.html') && !href.startsWith('http')) {
            link.href = href + '?key=' + currentKey;
          }
        });
      } else {
        // --- アクセス拒否 ---
        document.body.style.visibility = 'hidden';
        document.body.innerHTML = '<div style="text-align: center; padding-top: 50px; font-family: sans-serif;"><h1>アクセス権がありません</h1><p>このページは指定された場所からのみアクセスできます。</p></div>';
        document.body.style.visibility = 'visible';
        throw new Error("Invalid or missing access key.");
      }
    } catch (e) {
      // エラー発生時も念のため拒否
      document.body.style.visibility = 'hidden';
      document.body.innerHTML = '<div style="text-align: center; padding-top: 50px; font-family: sans-serif;"><h1>アクセス権がありません</h1><p>このページは指定された場所からのみアクセスできます。</p></div>';
      document.body.style.visibility = 'visible';
      throw new Error("Access denied due to an error during key check.");
    }
  });
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCS異常対応チェックリスト</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">DCS異常対応チェックリスト</h1>
        <div id="checklist-container"></div>
        <div class="mt-3 text-center">
            <button id="prev-btn" class="btn btn-secondary">戻る</button>
            <button id="next-btn" class="btn btn-primary">次へ</button>
            <button id="print-btn" class="btn btn-info">結果を印刷/PDF化</button>
            <button id="exit-btn" class="btn btn-danger">終了</button>
        </div>
    </div>
    <div id="printable-area"></div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
$(document).ready(function() {
    console.log("スクリプト開始");

    const csvData = `phase,phase_title,type,category,item,item_id,linked_item_id
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,オペレーターステーション（OPS）の画面全体または一部がフリーズ、表示が欠ける,1_0,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,プロセス値（温度、圧力、流量等）が更新されない、または異常値（ノイズ大、上限/下限に固定）を示す,1_1,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,制御ループがハンチング（振動）を起こす、または制御出力が最大/最小に振り切れる,1_2,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,システムのアラームサマリーに「コントローラー異常」「I/Oモジュール異常」「通信異常」等が多発する,1_3,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,フィールド機器（バルブ、ポンプ等）の実際の動作とOPS上の表示・状態が一致しない,1_4,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,DCS本体（コントローラー、I/Oユニット、電源ユニット）のステータスLEDが赤点灯または消灯している,1_5,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,サーバーやヒストリカルデータ収集装置からのデータ取得が失敗する,1_6,
1,"Phase 1: 異常検知・緊急停止",checklist,異常検知,その他,1_7,
1,"Phase 1: 異常検知・緊急停止",checklist,緊急停止措置,重大なプロセス異常に繋がる場合、関連する制御ループを手動（MAN）モードに切り替えた,1_8,
1,"Phase 1: 異常検知・緊急停止",checklist,緊急停止措置,安全上クリティカルな機器（緊急遮断弁、ポンプ等）を手動で安全な状態に操作した,1_9,
1,"Phase 1: 異常検知・緊急停止",checklist,緊急停止措置,システム管理者およびメンテナンス部門、関連部署へ異常発生を第一報連絡した,1_10,
1,"Phase 1: 異常検知・緊急停止",checklist,緊急停止措置,状況が改善しない場合、プラントの安全手順に従い、関連プロセスの停止を判断・実行した,1_11,
1,"Phase 1: 異常検知・緊急停止",checklist,緊急停止措置,関係者以外がDCSを操作しないよう、物理的またはシステム的にアクセスを制限した,1_12,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,アラーム・イベント確認,最初に発生したアラームとその発生時刻は何か,2_0,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,アラーム・イベント確認,同時刻に複数のアラームが発生しているか、その関連性は何か,2_1,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,画面表示確認,どのグラフィック画面で、どのタグ（測定点、制御点）に表示異常があるか,2_2,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,画面表示確認,正常に表示・更新されている画面やタグはあるか（異常範囲の特定）,2_3,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,操作状況確認,異常発生の直前に、どのような操作（設定値変更、モード切替、ロジック変更等）を行ったか,2_4,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,操作状況確認,定期的なバッチ処理やシーケンス制御の切り替わりのタイミングではなかったか,2_5,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,現場状況確認,現場計器の指示値とDCS画面上の値に差異はないか,2_6,
2,"Phase 2-1: 故障原因調査（使用部門）",checklist_with_status,現場状況確認,制御バルブやポンプは、DCSからの出力信号（開度指示等）通りに動作しているか,2_7,
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,アラーム・イベント確認,発生したアラーム、イベント、時刻を時系列で正確に記録し、メンテナンス部門へ報告する,3_0,2_0
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,アラーム・イベント確認,関連するアラーム画面やイベントリストのスクリーンショットを保存する,3_1,2_1
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,画面表示確認,異常が発生している画面名、タグ名を正確にリストアップして報告する,3_2,2_2
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,画面表示確認,異常範囲と正常範囲の境界を明確にし、原因切り分けの情報を提供する,3_3,2_3
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,操作状況確認,直前に行った操作内容、操作者、時刻を具体的に報告する,3_4,2_4
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,操作状況確認,関連する操作マニュアルや手順書を提示し、操作に誤りがなかったか再確認する,3_5,2_5
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,現場状況確認,現場計器の値とDCS画面の値の差異を写真等で記録し報告する,3_6,2_6
3,"Phase 3-1: 対策実施（使用部門）",checklist_with_status,現場状況確認,現場機器の動作状況（異音、振動、漏れ等）も併せて報告する,3_7,2_7
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,システムメッセージ・ログ解析,DCSのシステムログ、エラーログに記録されているエラーコードやメッセージは何か,4_0,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,システムメッセージ・ログ解析,サーバーやOPSのイベントビューア（OSログ）に異常な記録はないか,4_1,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,コントローラー(FCS)診断,CPU、メモリ、電源モジュールのステータスLED（RUN, ERR, BATT等）は正常か,4_2,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,コントローラー(FCS)診断,オンライン診断ツールで、コントローラーのCPU負荷率、メモリ使用率、スキャンタイムは正常範囲か,4_3,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,I/Oモジュール診断,異常が発生しているタグが接続されているI/OモジュールのステータスLEDは正常か,4_4,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,I/Oモジュール診断,I/Oモジュールの端子台で、現場からの信号（電圧、電流）が正常に来ているか（テスター等で測定）,4_5,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,I/Oモジュール診断,信号線の断線、短絡、端子の緩みはないか。ヒューズが切れていないか,4_6,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,制御ネットワーク診断,制御ネットワークスイッチ、光メディアコンバータの電源・リンク/アクティビティLEDは正常か,4_7,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,制御ネットワーク診断,ネットワーク管理ツールで、通信エラー（CRCエラー、コリジョン等）が多発していないか,4_8,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,制御ネットワーク診断,LANケーブルのコネクタの抜け、ケーブルの損傷（踏みつけ、屈曲）はないか,4_9,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,サーバー・OPS診断,サーバー、OPSのCPU使用率、メモリ使用量、ディスク空き容量は正常か,4_10,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,サーバー・OPS診断,DCS関連のソフトウェアプロセス（サービス）が正常に動作しているか,4_11,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,電源系統確認,各ユニット（コントローラー、I/O、サーバー等）への供給電圧は正常か,4_12,
4,"Phase 2-2: 故障原因調査（メンテナンス部門）",checklist_with_status,電源系統確認,UPS（無停電電源装置）がバッテリー運転になっていないか、エラー表示はないか,4_13,
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,システムメッセージ・ログ解析,エラーコードやメッセージに基づき、メーカーの技術マニュアルを参照し、指定された復旧手順を実施する,,4_0
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,システムメッセージ・ログ解析,OSのログに基づき、不要なサービスの停止やセキュリティパッチの適用を検討する,,4_1
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,コントローラー(FCS)診断,（プラントへの影響を最小限にする手順を確認後）故障したモジュールを予備品と交換する,,4_2
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,コントローラー(FCS)診断,（最終手段として、プラントの完全停止後）コントローラーの再起動またはリセットを行う,,4_3
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,I/Oモジュール診断,故障したI/Oモジュールを予備品と交換し、設定をダウンロードする,,4_4
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,I/Oモジュール診断,現場計器・操作端の電源や健全性を確認し、信号系統の問題を解決する,,4_5
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,I/Oモジュール診断,断線箇所を補修し、端子を増し締めする。切れたヒューズを定格品と交換する,,4_6
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,制御ネットワーク診断,故障したネットワーク機器（スイッチ、ハブ等）を予備品と交換し、設定をリストアする,,4_7
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,制御ネットワーク診断,通信負荷が高い場合は、不要な通信を停止するか、ネットワークセグメントの分割を検討する,,4_8
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,制御ネットワーク診断,損傷したLANケーブルを交換し、コネクタを確実に再接続する,,4_9
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,サーバー・OPS診断,サーバーまたはOPSを再起動する（関連システムへの影響を事前通知）,,4_10
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,サーバー・OPS診断,停止しているDCS関連サービスを再起動し、正常に動作することを確認する,,4_11
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,電源系統確認,故障した電源ユニットを予備品と交換する,,4_12
5,"Phase 3-2: 対策実施（メンテナンス部門）",checklist_with_status,電源系統確認,UPSの異常を解消（バッテリー交換、リセット等）し、正常な給電状態に復旧させる,,4_13
6,"Phase 4: 再起動前準備",checklist_with_status,復旧・安全確認,交換したハードウェア、修正したソフトウェア、変更したパラメータ等の作業内容を記録・確認した,6_0,
6,"Phase 4: 再起動前準備",checklist_with_status,復旧・安全確認,関連するプラント機器が安全な状態（手動モード、待機状態など）にあることを現場で確認した,6_1,
6,"Phase 4: 再起動前準備",checklist_with_status,復旧・安全確認,作業エリアの工具、資材等を撤去し、キャビネットの扉等が確実に閉められていることを確認した,6_2,
6,"Phase 4: 再起動前準備",checklist_with_status,データバックアップ,システム再起動の直前に、最新の制御ロジック、設定パラメータ、システムコンフィグレーションのバックアップを取得した,6_3,
6,"Phase 4: 再起動前準備",checklist_with_status,系統構成・電源投入,関連機器の電源を、メーカー指定の順序（例：ネットワーク機器→サーバー→コントローラー→OPS）で投入した,6_4,
6,"Phase 4: 再起動前準備",checklist_with_status,系統構成・電源投入,各機器の起動プロセスで、ハードウェアの初期診断エラーが発生しないことを確認した,6_5,
6,"Phase 4: 再起動前準備",checklist_with_status,システム起動・同期確認,OS、DCSシステムソフトウェアが正常に起動し、ログイン可能であることを確認した,6_6,
6,"Phase 4: 再起動前準備",checklist_with_status,システム起動・同期確認,コントローラー、サーバー、OPS間の通信が確立され、システム時刻が同期していることを確認した,6_7,
6,"Phase 4: 再起動前準備",checklist_with_status,最終確認,オペレーターとメンテナンス担当者で、復旧内容と試運転計画を共有し、異常時の連絡体制を再確認した,6_8,
7,"Phase 5: 試運転・正規運転",checklist_with_status,システム健全性確認,起動後のシステム自己診断でエラーがないか、全ユニットのステータスが正常（緑点灯）であることを確認した,7_0,
7,"Phase 5: 試運転・正規運転",checklist_with_status,システム健全性確認,アラームサマリーに不要なシステムアラームが表示されていないことを確認した,7_1,
7,"Phase 5: 試運転・正規運転",checklist_with_status,データ・表示確認,OPSのグラフィック画面で、全タグのプロセス値が正常に更新されていることを確認した,7_2,
7,"Phase 5: 試運転・正規運転",checklist_with_status,データ・表示確認,過去のトレンドデータ（ヒストリカルデータ）が欠損なく正常に表示されることを確認した,7_3,
7,"Phase 5: 試運転・正規運転",checklist_with_status,手動操作確認,主要な制御ループをMANモードにし、OPSから出力値（MV）を操作して現場機器が正しく応答することを確認した,7_4,
7,"Phase 5: 試運転・正規運転",checklist_with_status,手動操作確認,ポンプの起動/停止、バルブの開/閉といったデジタル出力の動作を確認した,7_5,
7,"Phase 5: 試運転・正規運転",checklist_with_status,自動制御・シーケンス確認,プラントへの影響が少ないループから順にAUTOモードに切り替え、制御が安定することを確認した（ハンチング、オフセットの有無）,7_6,
7,"Phase 5: 試運転・正規運転",checklist_with_status,自動制御・シーケンス確認,シーケンス制御やバッチ処理がある場合、ステップが正常に遷移することを確認した,7_7,
7,"Phase 5: 試運転・正規運転",checklist_with_status,インターロック確認,（可能であればシミュレーション機能や安全な範囲で）主要なインターロックが設定通りに機能することを確認した,7_8,
7,"Phase 5: 試運転・正規運転",checklist_with_status,正規運転への移行,全ての確認項目で異常がないことを確認し、オペレーターへ運転の引き継ぎを行う,7_9,
7,"Phase 5: 試運転・正規運転",checklist_with_status,正規運転への移行,正規運転開始後、一定時間は重点的にシステムの状態（CPU負荷、通信状況等）とプロセスを監視し、安定稼働を確認する,7_10,
7,"Phase 5: 試運転・正規運転",checklist_with_status,記録・報告,一連のトラブル対応（発生、原因、対策、結果）を作業完了報告書としてまとめ、関係者へ報告する,7_11,
`;

    let checklistData = [];
    let currentPhase = 1;
    let totalPhases = 0;
    let userSelections = {};
    const fileNameForStorage = "DCS_Checklist.html";

    const selectionKey = `userSelections_${fileNameForStorage}`;
    const phaseKey = `currentPhase_${fileNameForStorage}`;

    function initialize() {
        console.log("1. 初期化開始");
        try {
            const parsed = Papa.parse(csvData, { header: true, skipEmptyLines: true });
            checklistData = parsed.data;
            console.log("2. CSVデータ解析完了", checklistData);

            if (!checklistData || checklistData.length === 0) {
                console.error("エラー: checklistDataが空です。");
                $('#checklist-container').text("エラー: チェックリストデータが空か、不正な形式です。");
                return;
            }

            if (sessionStorage.getItem(selectionKey)) {
                userSelections = JSON.parse(sessionStorage.getItem(selectionKey));
            }
            if (sessionStorage.getItem(phaseKey)) {
                currentPhase = parseInt(sessionStorage.getItem(phaseKey));
            }
            console.log("3. sessionStorage読み込み完了", { userSelections, currentPhase });

            totalPhases = Math.max(...checklistData.map(item => parseInt(item.phase)));
            renderPhase(currentPhase);
        } catch (e) {
            console.error("初期化中にエラーが発生しました:", e);
            $('#checklist-container').text("エラー: アプリケーションの初期化に失敗しました。");
        }
    }

    function renderPhase(phase) {
        console.log(`4. Phase ${phase} のレンダリング開始`);
        let container = $('#checklist-container');
        container.empty();

        const phaseData = checklistData.filter(item => parseInt(item.phase) === phase);
        if (phaseData.length === 0) {
            console.log(`Phase ${phase} には項目がありません。`);
            if (phase <= totalPhases) {
                container.append('<p>このフェーズで表示する項目はありません。次へ進んでください。</p>');
            } else {
                container.append('<p>チェックリスト完了です。</p>');
            }
            updateNavigation();
            updateNextButtonState();
            return;
        }

        const phaseTitle = phaseData[0].phase_title;
        container.append(`<h2 class="phase-title">${phaseTitle}</h2>`);
        console.log(`5. Phaseタイトル '${phaseTitle}' を表示`);

        let itemsToShow = phaseData;
        if (phase === 3 || phase === 5) {
            const linkedPhaseNumber = phase === 3 ? 2 : 4;
            const problemItemIds = Object.values(userSelections)
                .filter(sel => sel.phase === linkedPhaseNumber && sel.value === '問題あり')
                .map(sel => sel.id);
            
            console.log(`Phase ${linkedPhaseNumber} からの問題項目ID:`, problemItemIds);
            itemsToShow = phaseData.filter(item => problemItemIds.includes(item.linked_item_id));

            if (itemsToShow.length === 0) {
                container.append('<p>前のフェーズで「問題あり」とされた項目はありません。次へ進んでください。</p>');
            }
        }

        if (itemsToShow.length > 0) {
            renderItems(itemsToShow, phase);
        }
        
        updateNavigation();
        updateNextButtonState();
    }
    
    function renderItems(items, phase) {
        const groupedByCategory = items.reduce((acc, item) => {
            (acc[item.category] = acc[item.category] || []).push(item);
            return acc;
        }, {});

        for (const category in groupedByCategory) {
            $('#checklist-container').append(`<h4 class="category-title">${category}</h4>`);
            const itemsInCategory = groupedByCategory[category];
            itemsInCategory.forEach(item => {
                const itemKey = item.item_id;
                const savedValue = userSelections[itemKey] ? userSelections[itemKey].value : undefined;
                let inputs = '';

                if (item.type === 'checklist') {
                    const isChecked = savedValue === 'checked';
                    inputs = `<input type="checkbox" class="form-check-input" data-item-key="${itemKey}" ${isChecked ? 'checked' : ''}>`;
                } else {
                    if (phase === 2 || phase === 4) {
                        const isOK = savedValue === '問題なし';
                        const isNG = savedValue === '問題あり';
                        inputs = `
                            <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                <label class="btn btn-outline-success ${isOK ? 'active' : ''}"><input type="radio" name="${itemKey}" value="問題なし" ${isOK ? 'checked' : ''}> 問題なし</label>
                                <label class="btn btn-outline-danger ${isNG ? 'active' : ''}"><input type="radio" name="${itemKey}" value="問題あり" ${isNG ? 'checked' : ''}> 問題あり</label>
                            </div>`;
                    } else {
                         const isDone = savedValue === '実施済み';
                         const isNA = savedValue === '非該当';
                         inputs = `
                             <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                 <label class="btn btn-outline-primary ${isDone ? 'active' : ''}"><input type="radio" name="${itemKey}" value="実施済み" ${isDone ? 'checked' : ''}> 実施済み</label>
                                 <label class="btn btn-outline-secondary ${isNA ? 'active' : ''}"><input type="radio" name="${itemKey}" value="非該当" ${isNA ? 'checked' : ''}> 非該当</label>
                             </div>`;
                    }
                }
                $('#checklist-container').append(`<div class="checklist-item-row"><label class="item-label">${item.item}</label><div>${inputs}</div></div>`);
            });
        }
        console.log("6. 全項目のレンダリング完了");
    }

    function updateNavigation() {
        $('#prev-btn').toggle(currentPhase > 1);
        $('#next-btn').toggle(currentPhase < totalPhases);
        $('#print-btn').toggle(currentPhase >= 3);
    }

    function updateNextButtonState() {
        let enabled = false;
        const phaseData = checklistData.filter(item => parseInt(item.phase) === currentPhase);

        if (phaseData.length === 0) {
            enabled = true; // Enable if there are no items in the phase
        } else if (currentPhase === 1) {
            const emergencyItems = phaseData.filter(i => i.category === '緊急停止措置');
            const detectionItems = phaseData.filter(i => i.category === '異常検知');
            
            const emergencyAllChecked = emergencyItems.every(item => userSelections[item.item_id] && userSelections[item.item_id].value === 'checked');
            const detectionOneChecked = detectionItems.some(item => userSelections[item.item_id] && userSelections[item.item_id].value === 'checked');
            
            enabled = emergencyAllChecked && detectionOneChecked;
        } else {
            let itemsToCheck = phaseData;
            if (currentPhase === 3 || currentPhase === 5) {
                const linkedPhaseNumber = currentPhase === 3 ? 2 : 4;
                const problemItemIds = Object.values(userSelections)
                    .filter(sel => sel.phase === linkedPhaseNumber && sel.value === '問題あり')
                    .map(sel => sel.id);
                itemsToCheck = itemsToCheck.filter(item => problemItemIds.includes(item.linked_item_id));
            }
            
            if (itemsToCheck.length === 0) {
                enabled = true;
            } else {
                enabled = itemsToCheck.every(item => userSelections[item.item_id]);
            }
        }
        $('#next-btn').prop('disabled', !enabled);
    }

    $('#checklist-container').on('change', 'input', function() {
        const key = $(this).attr('name') || $(this).data('item-key');
        const value = $(this).is(':checkbox') ? ($(this).is(':checked') ? 'checked' : 'unchecked') : $(this).val();
        
        userSelections[key] = { value: value, id: key, phase: currentPhase };
        sessionStorage.setItem(selectionKey, JSON.stringify(userSelections));
        updateNextButtonState();
    });

    $('#next-btn').click(function() {
        if (currentPhase < totalPhases) {
            currentPhase++;
            sessionStorage.setItem(phaseKey, currentPhase);
            renderPhase(currentPhase);
        }
    });

    $('#prev-btn').click(function() {
        if (currentPhase > 1) {
            currentPhase--;
            sessionStorage.setItem(phaseKey, currentPhase);
            renderPhase(currentPhase);
        }
    });

    $('#exit-btn').click(function() {
        if (confirm('メインメニューに戻りますか？\n(入力内容は保存されます)')) {
            window.location.href = 'index.html';
        }
    });

    $('#print-btn').click(function() {
        const checklistTitle = "DCS異常対応チェックリスト";

        let summaryHtml = `<div style="padding: 20px; font-family: sans-serif;"><h1>${checklistTitle} - 実施報告書</h1><p><strong>実施日:</strong> ${new Date().toLocaleDateString()}</p><hr>`;

        // Phase 1
        summaryHtml += '<h3>Phase 1: 異常検知・緊急停止の状況</h3>';
        const phase1_detection = checklistData.filter(item => parseInt(item.phase) === 1 && item.category === '異常検知');
        const phase1_stop = checklistData.filter(item => parseInt(item.phase) === 1 && item.category === '緊急停止措置');
        summaryHtml += '<h4>異常検知</h4><ul>';
        let detectionChecked = false;
        phase1_detection.forEach(item => {
            if (userSelections[item.item_id] && userSelections[item.item_id].value === 'checked') {
                summaryHtml += `<li>${item.item}</li>`;
                detectionChecked = true;
            }
        });
        if (!detectionChecked) summaryHtml += '<li>検知された異常はありません。</li>';
        summaryHtml += '</ul><h4>緊急停止措置</h4><ul>';
        phase1_stop.forEach(item => {
            const status = (userSelections[item.item_id] && userSelections[item.item_id].value === 'checked') ? '実施' : '未実施';
            summaryHtml += `<li>${item.item}: <strong>${status}</strong></li>`;
        });
        summaryHtml += '</ul><hr>';

        // Phase 2-1
        summaryHtml += '<h3>Phase 2-1: 故障原因調査（使用部門）</h3><ul>';
        const phase2Data = checklistData.filter(item => parseInt(item.phase) === 2);
        let causeInvestigated = false;
        phase2Data.forEach(item => {
            if (userSelections[item.item_id]) {
                summaryHtml += `<li>${item.item}: <strong>${userSelections[item.item_id].value}</strong></li>`;
                causeInvestigated = true;
            }
        });
        if (!causeInvestigated) summaryHtml += '<li>故障原因調査の項目はありません。</li>';
        summaryHtml += '</ul><hr>';

        // Phase 3-1 (Corrected Logic)
        summaryHtml += '<h3>Phase 3-1: 対策実施（使用部門）</h3><ul>';
        const problemItemIdsFromPhase2 = Object.values(userSelections)
            .filter(sel => sel.phase === 2 && sel.value === '問題あり')
            .map(sel => sel.id);
        const phase3ItemsToShow = checklistData.filter(item => 
            parseInt(item.phase) === 3 && problemItemIdsFromPhase2.includes(item.linked_item_id)
        );

        let measuresTaken = false;
        phase3ItemsToShow.forEach(item => {
            if (userSelections[item.item_id]) {
                summaryHtml += `<li>${item.item}: <strong>${userSelections[item.item_id].value}</strong></li>`;
                measuresTaken = true;
            }
        });

        if (!measuresTaken) {
            if (phase3ItemsToShow.length > 0) {
                 summaryHtml += '<li>選択された対策項目はありません。</li>';
            } else {
                 summaryHtml += '<li>前のフェーズで「問題あり」とされた項目がなかったため、対策項目はありません。</li>';
            }
        }
        summaryHtml += '</ul></div>';

        $('#printable-area').html(summaryHtml);
        window.print();
    });
    
    initialize();
});
    </script>
</body>
</html>