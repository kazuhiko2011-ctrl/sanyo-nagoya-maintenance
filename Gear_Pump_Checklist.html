<!DOCTYPE html>
<html lang="ja">
<head>

<!-- アクセス制限＆リンク修正用スクリプト -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    try {
      const SECRET_KEY = "93SYa4oyAeTbhKaC1Cj3hA";
      const params = new URLSearchParams(window.location.search);
      const currentKey = params.get('key');

      if (currentKey === SECRET_KEY) {
        // --- アクセス許可 ---
        // ページ内の全リンクを調べて、キーを付与する
        const links = document.querySelectorAll('a');
        links.forEach(link => {
          const href = link.getAttribute('href');
          // ローカルのHTMLファイルへのリンクかチェック (相対パスを想定)
          if (href && href.endsWith('.html') && !href.startsWith('http')) {
            link.href = href + '?key=' + currentKey;
          }
        });
      } else {
        // --- アクセス拒否 ---
        document.body.style.visibility = 'hidden';
        document.body.innerHTML = '<div style="text-align: center; padding-top: 50px; font-family: sans-serif;"><h1>アクセス権がありません</h1><p>このページは指定された場所からのみアクセスできます。</p></div>';
        document.body.style.visibility = 'visible';
        throw new Error("Invalid or missing access key.");
      }
    } catch (e) {
      // エラー発生時も念のため拒否
      document.body.style.visibility = 'hidden';
      document.body.innerHTML = '<div style="text-align: center; padding-top: 50px; font-family: sans-serif;"><h1>アクセス権がありません</h1><p>このページは指定された場所からのみアクセスできます。</p></div>';
      document.body.style.visibility = 'visible';
      throw new Error("Access denied due to an error during key check.");
    }
  });
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ギヤポンプ異常対応チェックリスト</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">ギヤポンプ異常対応チェックリスト</h1>
        <div id="checklist-container"></div>
        <div class="mt-3 text-center">
            <button id="prev-btn" class="btn btn-secondary">戻る</button>
            <button id="next-btn" class="btn btn-primary">次へ</button>
            <button id="print-btn" class="btn btn-info">結果を印刷/PDF化</button>
            <button id="exit-btn" class="btn btn-danger">終了</button>
        </div>
    </div>
    <div id="printable-area" class="d-none"></div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
        const csvData = `phase,phase_title,type,category,item,item_id,linked_item_id
1,異常検知・緊急停止,checklist,異常検知,ポンプから液体が吐出されない、または吐出量が著しく少ないか？,1_0,
1,異常検知・緊急停止,checklist,異常検知,吐出圧力が規定値まで上昇しない、または不安定ではないか？,1_1,
1,異常検知・緊急停止,checklist,異常検知,ポンプ本体やモーターから、きしみ音、打撃音などの異音は発生していないか？,1_2,
1,異常検知・緊急停止,checklist,異常検知,運転中に異常な振動が発生していないか？,1_3,
1,異常検知・緊急停止,checklist,異常検知,駆動軸のシール部（グランドパッキン、メカニカルシール）から液体が漏れていないか？,1_4,
1,異常検知・緊急停止,checklist,異常検知,モーターが過熱している、または過電流でトリップしていないか？,1_5,
1,異常検知・緊急停止,checklist,異常検知,圧力計や流量計の指示値が急激に変動していないか？,1_6,
1,異常検知・緊急停止,checklist,異常検知,その他,1_7,
1,異常検知・緊急停止,checklist,緊急停止措置,ポンプの緊急停止ボタンを操作する。,1_8,
1,異常検知・緊急停止,checklist,緊急停止措置,制御盤の主電源を遮断し、施錠（ロックアウト）および表示（タグアウト）を実施する。,1_9,
1,異常検知・緊急停止,checklist,緊急停止措置,ポンプの吸込側および吐出側のバルブを閉鎖する。,1_10,
1,異常検知・緊急停止,checklist,緊急停止措置,高温または危険な液体の場合、周辺区域への立ち入りを禁止し、安全を確保する。,1_11,
2,故障原因調査,checklist_with_status,運転状況確認,吸込側タンクの液面は十分か？（液切れしていないか）,2_0,
2,故障原因調査,checklist_with_status,運転状況確認,移送液の温度や粘度は、ポンプの仕様範囲内か？,2_1,
2,故障原因調査,checklist_with_status,運転状況確認,ポンプの回転方向は、ケーシングに示された矢印の向きと一致しているか？,2_2,
2,故障原因調査,checklist_with_status,外観・目視点検,吸込側配管ラインにあるストレーナー（フィルター）は詰まっていないか？,2_3,
2,故障原因調査,checklist_with_status,外観・目視点検,吸込側・吐出側のバルブは完全に開いているか？,2_4,
2,故障原因調査,checklist_with_status,外観・目視点検,配管のフランジ部や接続継手から、液体漏れや空気の吸い込み（エア噛み）はないか？,2_5,
2,故障原因調査,checklist_with_status,外観・目視点検,ポンプの基礎ボルトに緩みはないか？,2_6,
2,故障原因調査,checklist_with_status,駆動・伝達系統,モーターとポンプのカップリング（軸継手）に芯ずれ（ミスアライメント）はないか？,2_7,
2,故障原因調査,checklist_with_status,駆動・伝達系統,カップリングの防振ゴムやキー（回り止め）に損傷はないか？,2_8,
2,故障原因調査,checklist_with_status,駆動・伝達系統,モーター単体で運転した際に、異音や過大な振動はないか？（ベアリング損傷の可能性）,2_9,
2,故障原因調査,checklist_with_status,ポンプ本体・内部部品（分解点検）,駆動歯車および被動歯車の歯面に異常な摩耗や傷、欠けはないか？,2_10,
2,故障原因調査,checklist_with_status,ポンプ本体・内部部品（分解点検）,ケーシング内部やサイドプレートに、歯車との接触による摩耗痕はないか？,2_11,
2,故障原因調査,checklist_with_status,ポンプ本体・内部部品（分解点検）,軸受（ブッシュ）に異常な摩耗や焼き付きはないか？,2_12,
2,故障原因調査,checklist_with_status,ポンプ本体・内部部品（分解点検）,軸封（メカニカルシール、グランドパッキン）は損傷・劣化していないか？,2_13,
2,故障原因調査,checklist_with_status,ポンプ本体・内部部品,安全弁（リリーフバルブ）の設定圧は適切か？また、異物噛みによる作動不良はないか？,2_14,
2,故障原因調査,checklist_with_status,制御・電気系統,モーターへの供給電圧は三相とも均一で、規定値範囲内か？,2_15,
2,故障原因調査,checklist_with_status,制御・電気系統,インバーター制御の場合、パラメータ（周波数、加減速時間など）の設定は適切か？,2_16,
3,対策実施,checklist_with_status,運転状況確認,吸込側タンクに液体を補給する。,3_0,2_0
3,対策実施,checklist_with_status,運転状況確認,移送液の温度や粘度を仕様範囲内に調整する。,3_1,2_1
3,対策実施,checklist_with_status,運転状況確認,（メンテナンス部門へ依頼）モーターの結線を変更し、正しい回転方向にする。,3_2,2_2
3,対策実施,checklist_with_status,外観・目視点検,ストレーナーを分解し、内部を清掃する。,3_3,2_3
3,対策実施,checklist_with_status,外観・目視点検,バルブを完全に開ける。,3_4,2_4
3,対策実施,checklist_with_status,外観・目視点検,漏れている箇所やエアを吸い込んでいる箇所のボルトを増し締めするか、ガスケットを交換する。,3_5,2_5
3,対策実施,checklist_with_status,外観・目視点検,緩んでいる基礎ボルトを増し締めする。,3_6,2_6
3,対策実施,checklist_with_status,駆動・伝達系統,ダイヤルゲージ等を用いて、カップリングのアライメント調整（芯出し）を行う。,3_7,2_7
3,対策実施,checklist_with_status,駆動・伝達系統,損傷したカップリング部品を交換する。,3_8,2_8
3,対策実施,checklist_with_status,駆動・伝達系統,モーターのベアリングを交換する。,3_9,2_9
3,対策実施,checklist_with_status,ポンプ本体・内部部品,摩耗・損傷した歯車を交換する。,3_10,2_10
3,対策実施,checklist_with_status,ポンプ本体・内部部品,摩耗したケーシングやサイドプレートを交換する（またはポンプ本体を交換）。,3_11,2_11
3,対策実施,checklist_with_status,ポンプ本体・内部部品,摩耗・焼き付きした軸受を交換する。,3_12,2_12
3,対策実施,checklist_with_status,ポンプ本体・内部部品,損傷・劣化した軸封部品を交換する。,3_13,2_13
3,対策実施,checklist_with_status,ポンプ本体・内部部品,安全弁を分解清掃し、設定圧を再調整する。または安全弁を交換する。,3_14,2_14
3,対策実施,checklist_with_status,制御・電気系統,電源系統を点検し、電圧が不安定な原因を特定・修理する。,3_15,2_15
3,対策実施,checklist_with_status,制御・電気系統,インバーターのパラメータを、ポンプと運転条件に合わせて再設定する。,3_16,2_16
4,再起動前準備,checklist_with_status,復旧確認,交換した部品や修理した箇所は、メーカーの仕様通りに正しく組付けられているか？,4_0,
4,再起動前準備,checklist_with_status,復旧確認,ポンプ内部に呼び水（呼び液）は満たされているか？,4_1,
4,再起動前準備,checklist_with_status,復旧確認,工具、部品、ウエスなどがポンプ本体や周辺に放置されていないか？,4_2,
4,再起動前準備,checklist_with_status,安全確認,カップリングカバーなどの安全カバーは、所定の位置に確実に取り付けられているか？,4_3,
4,再起動前準備,checklist_with_status,電源投入,制御盤の主電源を投入し、エラー表示などが出ていないか確認したか？,4_5,
4,再起動前準備,checklist_with_status,状態記録,故障内容、原因、対策、交換部品などを設備台帳や作業報告書に正確に記録したか？,4_6,
5,試運転・正規運転,checklist_with_status,寸動運転,モーターを瞬間的に回転させ、回転方向が正しいこと、および引っ掛かりや異音がないことを確認したか？,5_0,4_0
5,試運転・正規運転,checklist_with_status,無負荷運転（可能であれば）,吐出側バルブを少し開けた状態で短時間運転し、エア抜きは完了したか？,5_1,4_1
5,試運転・正規運転,checklist_with_status,品質確認,吐出された液体に、金属粉などの異物が混入していないか？,5_2,4_2
5,試運転・正規運転,checklist_with_status,段階的な速度上昇,吐出側バルブを徐々に開き、正規の流量・圧力まで負荷をかけていく過程で、異常はないか？,5_3,4_3
5,試運転・正規運転,checklist_with_status,性能指標確認,正規の運転状態で、吐出圧力、流量、モーター電流値は規定値で安定しているか？,5_4,4_4
5,試運転・正規運転,checklist_with_status,性能指標確認,ポンプ本体、軸受部、モーターの表面温度に異常な上昇はないか？,5_5,4_5
5,試運転・正規運転,checklist_with_status,正規運転・監視,正規運転移行後、振動値や騒音レベルは基準値以下であり、安定しているか？,5_6,4_6`;

        let checklistData = [];
        let currentPhase = 1;
        let userSelections = {};
        const fileName = location.pathname.split("/").pop();
        const userSelectionsKey = `userSelections_${fileName}`;
        const currentPhaseKey = `currentPhase_${fileName}`;

        $(document).ready(function() {
            // データの初期化
            const storedSelections = sessionStorage.getItem(userSelectionsKey);
            if (storedSelections) {
                userSelections = JSON.parse(storedSelections);
            }
            const storedPhase = sessionStorage.getItem(currentPhaseKey);
            if (storedPhase) {
                currentPhase = parseInt(storedPhase, 10);
            }

            Papa.parse(csvData, {
                header: true,
                complete: function(results) {
                    checklistData = results.data;
                    renderPhase(currentPhase);
                }
            });

            // イベントハンドラ
            $('#prev-btn').on('click', () => {
                if (currentPhase > 1) {
                    currentPhase--;
                    saveState();
                    renderPhase(currentPhase);
                }
            });

            $('#next-btn').on('click', () => {
                const maxPhase = Math.max(...checklistData.map(item => parseInt(item.phase, 10)));
                if (currentPhase < maxPhase) {
                    currentPhase++;
                    saveState();
                    renderPhase(currentPhase);
                }
            });
            
            $('#print-btn').on('click', function() {
                const printableArea = $('#printable-area');
                printableArea.html(generateReport());
                printableArea.removeClass('d-none');
                window.print();
                printableArea.addClass('d-none');
            });

            $('#exit-btn').on('click', () => {
                if (confirm('終了しますか？入力内容は保存されます。')) {
                    window.location.href = 'index.html';
                }
            });
        });

        function saveState() {
            sessionStorage.setItem(userSelectionsKey, JSON.stringify(userSelections));
            sessionStorage.setItem(currentPhaseKey, currentPhase);
        }

        function renderPhase(phase) {
            const container = $('#checklist-container');
            container.empty();
            
            let itemsToShow = checklistData.filter(item => parseInt(item.phase, 10) === phase);
            const phaseTitle = itemsToShow.length > 0 ? itemsToShow[0].phase_title : '';

            container.append(`<h2 class="phase-title">Phase ${phase}: ${phaseTitle}</h2>`);

            if (phase === 3 || phase === 5) {
                const previousPhase = phase === 3 ? 2 : 4;
                const problemItems = Object.keys(userSelections).filter(key => 
                    key.startsWith(`${previousPhase}_`) && userSelections[key] === '問題あり'
                );
                itemsToShow = itemsToShow.filter(item => problemItems.includes(item.linked_item_id));
            }
            
            const groupedItems = itemsToShow.reduce((acc, item) => {
                (acc[item.category] = acc[item.category] || []).push(item);
                return acc;
            }, {});

            for (const category in groupedItems) {
                container.append(`<h3 class="category-title">${category}</h3>`);
                groupedItems[category].forEach(item => {
                    const itemHtml = createItemHtml(item);
                    container.append(itemHtml);
                });
            }
            
            updateNavigation();
            attachEventListeners();
        }

        function createItemHtml(item) {
            const selection = userSelections[item.item_id] || '';
            let inputHtml = '';

            if (item.type === 'checklist') {
                inputHtml = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${item.item_id}" id="${item.item_id}" ${selection ? 'checked' : ''}>
                    </div>`;
            } else if (item.type === 'checklist_with_status') {
                const buttons = (item.phase === '2' || item.phase === '4') 
                    ? ['問題なし', '問題あり'] 
                    : ['実施済み', '非該当'];
                
                inputHtml = `
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-outline-success ${selection === buttons[0] ? 'active' : ''}">
                            <input type="radio" name="${item.item_id}" value="${buttons[0]}" ${selection === buttons[0] ? 'checked' : ''}> ${buttons[0]}
                        </label>
                        <label class="btn btn-outline-danger ${selection === buttons[1] ? 'active' : ''}">
                            <input type="radio" name="${item.item_id}" value="${buttons[1]}" ${selection === buttons[1] ? 'checked' : ''}> ${buttons[1]}
                        </label>
                    </div>`;
            }

            return `
                <div class="checklist-item-row">
                    <label class="item-label" for="${item.item_id}">${item.item}</label>
                    ${inputHtml}
                </div>`;
        }

        function attachEventListeners() {
            $('.form-check-input').off('change').on('change', function() {
                if (this.checked) {
                    userSelections[this.id] = true;
                } else {
                    delete userSelections[this.id];
                }
                saveState();
                updateNavigation();
            });

            $('.btn-group-toggle input[type="radio"]').off('change').on('change', function() {
                userSelections[this.name] = this.value;
                saveState();
                updateNavigation();
            });
        }

        function updateNavigation() {
            const maxPhase = Math.max(...checklistData.map(item => parseInt(item.phase, 10)));
            $('#prev-btn').toggle(currentPhase > 1);
            $('#next-btn').toggle(currentPhase < maxPhase);
            $('#print-btn').toggle(currentPhase >= 3);

            let isPhaseComplete = false;
            const itemsInPhase = checklistData.filter(item => parseInt(item.phase, 10) === currentPhase);

            if (currentPhase === 1) {
                const abnormalConditionItems = itemsInPhase.filter(i => i.category === '異常検知');
                const emergencyStopItems = itemsInPhase.filter(i => i.category === '緊急停止措置');
                
                const isAbnormalChecked = abnormalConditionItems.some(i => userSelections[i.item_id]);
                const areAllEmergencyStopsChecked = emergencyStopItems.every(i => userSelections[i.item_id]);

                isPhaseComplete = isAbnormalChecked && areAllEmergencyStopsChecked;
            } else {
                 let itemsToCheck = itemsInPhase;
                 if (currentPhase === 3 || currentPhase === 5) {
                    const previousPhase = currentPhase === 3 ? 2 : 4;
                    const problemItems = Object.keys(userSelections).filter(key => 
                        key.startsWith(`${previousPhase}_`) && userSelections[key] === '問題あり'
                    );
                    itemsToCheck = itemsInPhase.filter(item => problemItems.includes(item.linked_item_id));
                 }
                isPhaseComplete = itemsToCheck.every(item => userSelections[item.item_id]);
            }
            
            $('#next-btn').prop('disabled', !isPhaseComplete);
        }
        
        function generateReport() {
            let reportHtml = `
                <style>
                    body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
                    .report-container { width: 80%; margin: auto; border: 1px solid #ccc; padding: 20px; }
                    .report-header { text-align: center; margin-bottom: 20px; }
                    .report-section { margin-bottom: 15px; }
                    .report-section h3 { border-bottom: 2px solid #333; padding-bottom: 5px; }
                    .report-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
                    .report-item:last-child { border-bottom: none; }
                </style>
                <div class="report-container">
                    <div class="report-header">
                        <h1>実施報告書</h1>
                        <p><strong>チェックリスト:</strong> ギヤポンプ（業務用）異常対応チェックリスト</p>
                        <p><strong>実施日時:</strong> ${new Date().toLocaleString('ja-JP')}</p>
                    </div>`;

            const allPhases = [...new Set(checklistData.map(item => item.phase))].sort();

            allPhases.forEach(phaseNum => {
                const phaseItems = checklistData.filter(item => item.phase === phaseNum);
                if (phaseItems.length === 0) return;

                const phaseTitle = phaseItems[0].phase_title;
                let sectionHtml = `<div class="report-section"><h3>Phase ${phaseNum}: ${phaseTitle}</h3>`;
                let hasContent = false;

                const groupedItems = phaseItems.reduce((acc, item) => {
                    (acc[item.category] = acc[item.category] || []).push(item);
                    return acc;
                }, {});

                for (const category in groupedItems) {
                    let categoryContent = '';
                    groupedItems[category].forEach(item => {
                        const selection = userSelections[item.item_id];
                        if (selection) {
                            const resultText = selection === true ? "実施" : selection;
                            categoryContent += `<div class="report-item"><span>${item.item}</span><strong>${resultText}</strong></div>`;
                        }
                    });
                    if (categoryContent) {
                        hasContent = true;
                        sectionHtml += `<h4>${category}</h4>` + categoryContent;
                    }
                }
                sectionHtml += `</div>`;
                if(hasContent) {
                    reportHtml += sectionHtml;
                }
            });

            reportHtml += `</div>`;
            return reportHtml;
        }
    </script>
</body>
</html>