<!DOCTYPE html>
<html lang="ja">
<head>

<!-- アクセス制限＆リンク修正用スクリプト -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    try {
      const SECRET_KEY = "93SYa4oyAeTbhKaC1Cj3hA";
      const params = new URLSearchParams(window.location.search);
      const currentKey = params.get('key');

      if (currentKey === SECRET_KEY) {
        // --- アクセス許可 ---
        // ページ内の全リンクを調べて、キーを付与する
        const links = document.querySelectorAll('a');
        links.forEach(link => {
          const href = link.getAttribute('href');
          // ローカルのHTMLファイルへのリンクかチェック (相対パスを想定)
          if (href && href.endsWith('.html') && !href.startsWith('http')) {
            link.href = href + '?key=' + currentKey;
          }
        });
      } else {
        // --- アクセス拒否 ---
        document.body.style.visibility = 'hidden';
        document.body.innerHTML = '<div style="text-align: center; padding-top: 50px; font-family: sans-serif;"><h1>アクセス権がありません</h1><p>このページは指定された場所からのみアクセスできます。</p></div>';
        document.body.style.visibility = 'visible';
        throw new Error("Invalid or missing access key.");
      }
    } catch (e) {
      // エラー発生時も念のため拒否
      document.body.style.visibility = 'hidden';
      document.body.innerHTML = '<div style="text-align: center; padding-top: 50px; font-family: sans-serif;"><h1>アクセス権がありません</h1><p>このページは指定された場所からのみアクセスできます。</p></div>';
      document.body.style.visibility = 'visible';
      throw new Error("Access denied due to an error during key check.");
    }
  });
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ヒューガルポンプ異常対応チェックリスト</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">ヒューガルポンプ異常対応チェックリスト</h1>
        <div id="checklist-container"></div>
        <div class="mt-3 text-center">
            <button id="prev-btn" class="btn btn-secondary">戻る</button>
            <button id="next-btn" class="btn btn-primary">次へ</button>
            <button id="print-btn" class="btn btn-info">結果を印刷/PDF化</button>
            <button id="exit-btn" class="btn btn-danger">終了</button>
        </div>
    </div>
    <div id="printable-area" class="d-none"></div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        const checklistData = [
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "異常検知", item: "ポンプが水を吸い上げない（揚水不良）", item_id: "1_0", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "異常検知", item: "吐出量が少ない、または不安定", item_id: "1_1", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "異常検知", item: "ポンプ本体または配管から水漏れがある", item_id: "1_2", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "異常検知", item: "モーターまたはポンプ本体から異音がする（ガラガラ、キーキー等）", item_id: "1_3", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "異常検知", item: "ポンプ本体またはモーターに異常な振動がある", item_id: "1_4", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "異常検知", item: "モーターが異常に発熱している、または焦げ臭い匂いがする", item_id: "1_5", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "異常検知", item: "圧力計・流量計の指示値が異常である", item_id: "1_6", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "異常検知", item: "制御盤の警報ランプが点灯、またはエラーが表示されている", item_id: "1_7", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "異常検知", item: "その他", item_id: "1_8", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "緊急停止措置", item: "ポンプの非常停止ボタンを押す", item_id: "1_9", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "緊急停止措置", item: "主電源（ブレーカー）を遮断する", item_id: "1_10", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "緊急停止措置", item: "電源遮断箇所にロックアウト/タグアウトを実施する", item_id: "1_11", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "緊急停止措置", item: "ポンプ前後のバルブ（吸込側、吐出側）を閉止する", item_id: "1_12", linked_item_id: "" },
            { phase: 1, phase_title: "異常検知・緊急停止", type: "checklist", category: "緊急停止措置", item: "関連部署およびメンテナンス部門に異常発生を報告する", item_id: "1_13", linked_item_id: "" },

            { phase: 2, phase_title: "故障原因調査（使用部門）", type: "checklist_with_status", category: "運転状況", item: "起動操作手順に誤りがある", item_id: "2_0", linked_item_id: "" },
            { phase: 2, phase_title: "故障原因調査（使用部門）", type: "checklist_with_status", category: "運転状況", item: "運転設定（流量、圧力）が不適切である", item_id: "2_1", linked_item_id: "" },
            { phase: 2, phase_title: "故障原因調査（使用部門）", type: "checklist_with_status", category: "吸込側", item: "吸込側のストレーナーが詰まっている", item_id: "2_2", linked_item_id: "" },
            { phase: 2, phase_title: "故障原因調査（使用部門）", type: "checklist_with_status", category: "吸込側", item: "吸込配管の先端が水面上に出て空気を吸い込んでいる", item_id: "2_3", linked_item_id: "" },
            { phase: 2, phase_title: "故障原因調査（使用部門）", type: "checklist_with_status", category: "吸込側", item: "吸込側のバルブが閉じている、または開き度が不足している", item_id: "2_4", linked_item_id: "" },
            { phase: 2, phase_title: "故障原因調査（使用部門）", type: "checklist_with_status", category: "吸込側", item: "フート弁の動作に異常がある", item_id: "2_5", linked_item_id: "" },
            { phase: 2, phase_title: "故障原因調査（使用部門）", type: "checklist_with_status", category: "吐出側", item: "吐出側のバルブが全開、または全閉になっている", item_id: "2_6", linked_item_id: "" },
            { phase: 2, phase_title: "故障原因調査（使用部門）", type: "checklist_with_status", category: "吐出側", item: "吐出配管の系統に詰まりがある", item_id: "2_7", linked_item_id: "" },
            { phase: 2, phase_title: "故障原因調査（使用部門）", type: "checklist_with_status", category: "周辺環境", item: "ポンプ周辺に漏れた液体がある", item_id: "2_8", linked_item_id: "" },
            { phase: 2, phase_title: "故障原因調査（使用部門）", type: "checklist_with_status", category: "周辺環境", item: "設置場所の換気が悪く、モーターが過熱している", item_id: "2_9", linked_item_id: "" },

            { phase: 3, phase_title: "対策実施（使用部門）", type: "checklist_with_status", category: "運転状況", item: "正しい起動操作手順を確認し、再操作する", item_id: "3_0", linked_item_id: "2_0" },
            { phase: 3, phase_title: "対策実施（使用部門）", type: "checklist_with_status", category: "運転状況", item: "運転設定を適正値に修正する", item_id: "3_1", linked_item_id: "2_1" },
            { phase: 3, phase_title: "対策実施（使用部門）", type: "checklist_with_status", category: "吸込側", item: "吸込側のストレーナーを清掃する", item_id: "3_2", linked_item_id: "2_2" },
            { phase: 3, phase_title: "対策実施（使用部門）", type: "checklist_with_status", category: "吸込側", item: "吸込配管の先端が完全に水没するように調整する", item_id: "3_3", linked_item_id: "2_3" },
            { phase: 3, phase_title: "対策実施（使用部門）", type: "checklist_with_status", category: "吸込側", item: "吸込側のバルブを全開にする", item_id: "3_4", linked_item_id: "2_4" },
            { phase: 3, phase_title: "対策実施（使用部門）", type: "checklist_with_status", category: "吸込側", item: "フート弁の点検・清掃を実施する", item_id: "3_5", linked_item_id: "2_5" },
            { phase: 3, phase_title: "対策実施（使用部門）", type: "checklist_with_status", category: "吐出側", item: "吐出側のバルブを適切な開度に調整する", item_id: "3_6", linked_item_id: "2_6" },
            { phase: 3, phase_title: "対策実施（使用部門）", type: "checklist_with_status", category: "吐出側", item: "吐出配管の詰まりを除去する", item_id: "3_7", linked_item_id: "2_7" },
            { phase: 3, phase_title: "対策実施（使用部門）", type: "checklist_with_status", category: "周辺環境", item: "漏れた液体を拭き取り、漏洩箇所を特定し報告する", item_id: "3_8", linked_item_id: "2_8" },
            { phase: 3, phase_title: "対策実施（使用部門）", type: "checklist_with_status", category: "周辺環境", item: "ポンプ周囲の換気を確保する", item_id: "3_9", linked_item_id: "2_9" },

            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "呼び水・ケーシング", item: "呼び水が不足している、または無くなっている", item_id: "4_0", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "呼び水・ケーシング", item: "ケーシングのドレンプラグやエア抜きプラグが緩んでいる", item_id: "4_1", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "モーター・動力", item: "モーターが回転しない", item_id: "4_2", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "モーター・動力", item: "モーターの回転方向が逆である", item_id: "4_3", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "モーター・動力", item: "電源の欠相、または電圧が低下している", item_id: "4_4", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "モーター・動力", item: "モーターの過負荷保護装置（サーマルリレー）が作動している", item_id: "4_5", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "インペラ（羽根車）", item: "インペラが摩耗または損傷している", item_id: "4_6", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "インペラ（羽根車）", item: "インペラとケーシングの間に異物が詰まっている", item_id: "4_7", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "メカニカルシール", item: "メカニカルシール部から著しく漏水している", item_id: "4_8", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "メカニカルシール", item: "メカニカルシール摺動面が損傷・摩耗している", item_id: "4_9", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "軸・軸受", item: "ポンプの軸が固着・ロックしている", item_id: "4_10", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "軸・軸受", item: "軸受（ベアリング）が摩耗または損傷し、異音や発熱がある", item_id: "4_11", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "配管・フランジ", item: "吸込配管の接続部（フランジ等）から空気を吸い込んでいる", item_id: "4_12", linked_item_id: "" },
            { phase: 4, phase_title: "故障原因調査（メンテナンス部門）", type: "checklist_with_status", category: "配管・フランジ", item: "配管の支持が不十分で、ポンプに過大な荷重がかかっている", item_id: "4_13", linked_item_id: "" },

            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "呼び水・ケーシング", item: "ケーシング内に呼び水を満たす", item_id: "5_0", linked_item_id: "4_0" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "呼び水・ケーシング", item: "ドレンプラグやエア抜きプラグを増し締め、またはシールテープを交換して締め直す", item_id: "5_1", linked_item_id: "4_1" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "モーター・動力", item: "モーターまたは電源系統の診断・修理を実施する", item_id: "5_2", linked_item_id: "4_2" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "モーター・動力", item: "モーターの結線を修正し、正しい回転方向にする", item_id: "5_3", linked_item_id: "4_3" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "モーター・動力", item: "電源系統を点検し、規定電圧を確保する", item_id: "5_4", linked_item_id: "4_4" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "モーター・動力", item: "過負荷の原因を調査・除去し、サーマルリレーをリセットする", item_id: "5_5", linked_item_id: "4_5" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "インペラ（羽根車）", item: "インペラを交換する", item_id: "5_6", linked_item_id: "4_6" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "インペラ（羽根車）", item: "ポンプを分解し、インペラとケーシングの間の異物を除去する", item_id: "5_7", linked_item_id: "4_7" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "メカニカルシール", item: "メカニカルシールを交換する", item_id: "5_8", linked_item_id: "4_8" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "メカニカルシール", item: "メカニカルシールを交換する", item_id: "5_9", linked_item_id: "4_9" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "軸・軸受", item: "ポンプを分解し、固着・ロックの原因を除去する", item_id: "5_10", linked_item_id: "4_10" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "軸・軸受", item: "軸受（ベアリング）を交換する", item_id: "5_11", linked_item_id: "4_11" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "配管・フランジ", item: "吸込配管の接続部のガスケット交換や増し締めを実施する", item_id: "5_12", linked_item_id: "4_12" },
            { phase: 5, phase_title: "対策実施（メンテナンス部門）", type: "checklist_with_status", category: "配管・フランジ", item: "配管の支持を見直し、ポンプに荷重がかからないように修正する", item_id: "5_13", linked_item_id: "4_13" },

            { phase: 6, phase_title: "再起動前準備", type: "checklist_with_status", category: "安全確認", item: "ロックアウト/タグアウトが解除されていることを確認する", item_id: "6_0", linked_item_id: "" },
            { phase: 6, phase_title: "再起動前準備", type: "checklist_with_status", category: "復旧確認", item: "修理・交換箇所に問題がないことを目視で確認する", item_id: "6_1", linked_item_id: "" },
            { phase: 6, phase_title: "再起動前準備", type: "checklist_with_status", category: "周辺確認", item: "工具や部品がポンプ周辺に残置されていないことを確認する", item_id: "6_2", linked_item_id: "" },
            { phase: 6, phase_title: "再起動前準備", type: "checklist_with_status", category: "系統確認", item: "ポンプ前後のバルブが規定の位置にあることを確認する（吸込側：開、吐出側：閉または少し開）", item_id: "6_3", linked_item_id: "" },
            { phase: 6, phase_title: "再起動前準備", type: "checklist_with_status", category: "初期設定", item: "ケーシング内に呼び水が満たされていることを確認する", item_id: "6_4", linked_item_id: "" },
            { phase: 6, phase_title: "再起動前準備", type: "checklist_with_status", category: "初期設定", item: "軸を手で回し、スムーズに回転することを確認する", item_id: "6_5", linked_item_id: "" },

            { phase: 7, phase_title: "試運転・正規運転", type: "checklist_with_status", category: "インチング運転", item: "電源を瞬間的に投入・遮断し、モーターの回転方向が正しいことを確認する", item_id: "7_0", linked_item_id: "6_0" },
            { phase: 7, phase_title: "試運転・正規運転", type: "checklist_with_status", category: "短時間試運転", item: "吐出側バルブを閉じた状態でポンプを起動し、異音、異常振動、水漏れがないことを確認する", item_id: "7_1", linked_item_id: "6_1" },
            { phase: 7, phase_title: "試運転・正規運転", type: "checklist_with_status", category: "短時間試運転", item: "軸受やモーターの温度が急上昇しないことを確認する", item_id: "7_2", linked_item_id: "6_2" },
            { phase: 7, phase_title: "試運転・正規運転", type: "checklist_with_status", category: "負荷運転", item: "吐出側のバルブを徐々に開き、負荷をかける", item_id: "7_3", linked_item_id: "6_3" },
            { phase: 7, phase_title: "試運転・正規運転", type: "checklist_with_status", category: "負荷運転", item: "吐出圧力、流量が規定値に達することを確認する", item_id: "7_4", linked_item_id: "6_4" },
            { phase: 7, phase_title: "試運転・正規運転", type: "checklist_with_status", category: "負荷運転", item: "電流値が定格範囲内であることを測定・確認する", item_id: "7_5", linked_item_id: "6_5" },
            { phase: 7, phase_title: "試運転・正規運転", type: "checklist_with_status", category: "正規運転", item: "各種計器類（圧力、流量、電流、温度）が安定していることを確認し、正規運転に移行する", item_id: "7_6", linked_item_id: "" },
            { phase: 7, phase_title: "試運転・正規運転", type: "checklist_with_status", category: "正規運転", item: "運転記録（圧力、電流値、運転時間等）を記録する", item_id: "7_7", linked_item_id: "" }
        ];

        let currentPhase = 1;
        let userSelections = {};
        const fileName = location.pathname.split("/").pop();
        const userSelectionsKey = `userSelections_${fileName}`;
        const currentPhaseKey = `currentPhase_${fileName}`;

        $(document).ready(function() {
            const storedSelections = sessionStorage.getItem(userSelectionsKey);
            if (storedSelections) {
                userSelections = JSON.parse(storedSelections);
            }
            const storedPhase = sessionStorage.getItem(currentPhaseKey);
            if (storedPhase) {
                currentPhase = parseInt(storedPhase, 10);
            }

            renderPhase(currentPhase);

            $('#prev-btn').on('click', () => {
                if (currentPhase > 1) {
                    currentPhase--;
                    saveState();
                    renderPhase(currentPhase);
                }
            });

            $('#next-btn').on('click', () => {
                const maxPhase = Math.max(...checklistData.map(item => item.phase));
                if (currentPhase < maxPhase) {
                    currentPhase++;
                    saveState();
                    renderPhase(currentPhase);
                }
            });
            
            $('#print-btn').on('click', function() {
                const printableArea = $('#printable-area');
                printableArea.html(generateReport());
                printableArea.removeClass('d-none');
                window.print();
                printableArea.addClass('d-none');
            });

            $('#exit-btn').on('click', () => {
                if (confirm('終了しますか？入力内容は保存されます。')) {
                    window.location.href = 'index.html';
                }
            });
        });

        function saveState() {
            sessionStorage.setItem(userSelectionsKey, JSON.stringify(userSelections));
            sessionStorage.setItem(currentPhaseKey, currentPhase);
        }

        function renderPhase(phase) {
            const container = $('#checklist-container');
            container.empty();
            
            let itemsToShow = checklistData.filter(item => item.phase === phase);
            const phaseTitle = itemsToShow.length > 0 ? itemsToShow[0].phase_title : '';

            container.append(`<h2 class="phase-title">Phase ${phase}: ${phaseTitle}</h2>`);

            // 対策フェーズのフィルタリングロジック
            if (phase === 3) { // 対策実施（使用部門）
                const problemItems = Object.keys(userSelections).filter(key => 
                    key.startsWith(`2_`) && userSelections[key] === '問題あり'
                );
                itemsToShow = itemsToShow.filter(item => problemItems.includes(item.linked_item_id));
            } else if (phase === 5) { // 対策実施（メンテナンス部門）
                const problemItems = Object.keys(userSelections).filter(key => 
                    key.startsWith(`4_`) && userSelections[key] === '問題あり'
                );
                itemsToShow = itemsToShow.filter(item => problemItems.includes(item.linked_item_id));
            } else if (phase === 7) { // 試運転・正規運転
                const problemItems = Object.keys(userSelections).filter(key => 
                    key.startsWith(`6_`) && userSelections[key] === '実施済み'
                );
                itemsToShow = itemsToShow.filter(item => problemItems.includes(item.linked_item_id));
            }
            
            const groupedItems = itemsToShow.reduce((acc, item) => {
                (acc[item.category] = acc[item.category] || []).push(item);
                return acc;
            }, {});

            for (const category in groupedItems) {
                container.append(`<h3 class="category-title">${category}</h3>`);
                groupedItems[category].forEach(item => {
                    const itemHtml = createItemHtml(item);
                    container.append(itemHtml);
                });
            }
            
            updateNavigation();
            attachEventListeners();
        }

        function createItemHtml(item) {
            const selection = userSelections[item.item_id] || '';
            let inputHtml = '';

            if (item.type === 'checklist') {
                inputHtml = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${item.item_id}" id="${item.item_id}" ${selection ? 'checked' : ''}>
                    </div>`;
            } else if (item.type === 'checklist_with_status') {
                let buttons;
                if (item.phase === 2 || item.phase === 4) {
                    buttons = ['問題なし', '問題あり'];
                } else {
                    buttons = ['実施済み', '非該当'];
                }
                
                inputHtml = `
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-outline-success ${selection === buttons[0] ? 'active' : ''}">
                            <input type="radio" name="${item.item_id}" value="${buttons[0]}" ${selection === buttons[0] ? 'checked' : ''}> ${buttons[0]}
                        </label>
                        <label class="btn btn-outline-danger ${selection === buttons[1] ? 'active' : ''}">
                            <input type="radio" name="${item.item_id}" value="${buttons[1]}" ${selection === buttons[1] ? 'checked' : ''}> ${buttons[1]}
                        </label>
                    </div>`;
            }

            return `
                <div class="checklist-item-row">
                    <label class="item-label" for="${item.item_id}">${item.item}</label>
                    ${inputHtml}
                </div>`;
        }

        function attachEventListeners() {
            $('.form-check-input').off('change').on('change', function() {
                if (this.checked) {
                    userSelections[this.id] = true;
                } else {
                    delete userSelections[this.id];
                }
                saveState();
                updateNavigation();
            });

            $('.btn-group-toggle input[type="radio"]').off('change').on('change', function() {
                userSelections[this.name] = this.value;
                saveState();
                updateNavigation();
            });
        }

        function updateNavigation() {
            const maxPhase = Math.max(...checklistData.map(item => item.phase));
            $('#prev-btn').toggle(currentPhase > 1);
            $('#next-btn').toggle(currentPhase < maxPhase);
            $('#print-btn').toggle(currentPhase >= 3);

            let isPhaseComplete = false;
            let itemsInPhase = checklistData.filter(item => item.phase === currentPhase);

            if (currentPhase === 1) {
                const abnormalConditionItems = itemsInPhase.filter(i => i.category === '異常検知');
                const emergencyStopItems = itemsInPhase.filter(i => i.category === '緊急停止措置');
                
                const isAbnormalChecked = abnormalConditionItems.some(i => userSelections[i.item_id]);
                const areAllEmergencyStopsChecked = emergencyStopItems.every(i => userSelections[i.item_id]);

                isPhaseComplete = isAbnormalChecked && areAllEmergencyStopsChecked;
            } else if (currentPhase === 3) { // 対策実施（使用部門）
                const previousPhase = 2;
                const problemItems = Object.keys(userSelections).filter(key => 
                    key.startsWith(`${previousPhase}_`) && userSelections[key] === '問題あり'
                );
                itemsInPhase = itemsInPhase.filter(item => problemItems.includes(item.linked_item_id));
                isPhaseComplete = itemsInPhase.every(item => userSelections[item.item_id]);
            } else if (currentPhase === 5) { // 対策実施（メンテナンス部門）
                const previousPhase = 4;
                const problemItems = Object.keys(userSelections).filter(key => 
                    key.startsWith(`${previousPhase}_`) && userSelections[key] === '問題あり'
                );
                itemsInPhase = itemsInPhase.filter(item => problemItems.includes(item.linked_item_id));
                isPhaseComplete = itemsInPhase.every(item => userSelections[item.item_id]);
            } else if (currentPhase === 7) { // 試運転・正規運転
                const previousPhase = 6;
                const problemItems = Object.keys(userSelections).filter(key => 
                    key.startsWith(`${previousPhase}_`) && userSelections[key] === '実施済み'
                );
                itemsInPhase = itemsInPhase.filter(item => problemItems.includes(item.linked_item_id));
                isPhaseComplete = itemsInPhase.every(item => userSelections[item.item_id]);
            } else {
                isPhaseComplete = itemsInPhase.every(item => userSelections[item.item_id]);
            }
            
            $('#next-btn').prop('disabled', !isPhaseComplete);
        }
        
        function generateReport() {
            let reportHtml = `
                <style>
                    body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
                    .report-container { width: 80%; margin: auto; border: 1px solid #ccc; padding: 20px; }
                    .report-header { text-align: center; margin-bottom: 20px; }
                    .report-section { margin-bottom: 15px; }
                    .report-section h3 { border-bottom: 2px solid #333; padding-bottom: 5px; }
                    .report-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
                    .report-item:last-child { border-bottom: none; }
                </style>
                <div class="report-container">
                    <div class="report-header">
                        <h1>実施報告書</h1>
                        <p><strong>チェックリスト:</strong> ヒューガルポンプ異常対応チェックリスト</p>
                        <p><strong>実施日時:</strong> ${new Date().toLocaleString('ja-JP')}</p>
                    </div>`;

            const allPhases = [...new Set(checklistData.map(item => item.phase))].sort((a, b) => a - b);

            allPhases.forEach(phaseNum => {
                let phaseItems = checklistData.filter(item => item.phase === phaseNum);
                if (phaseItems.length === 0) return;

                const phaseTitle = phaseItems[0].phase_title;
                let sectionHtml = `<div class="report-section"><h3>Phase ${phaseNum}: ${phaseTitle}</h3>`;
                let hasContent = false;

                // 対策フェーズのフィルタリングロジック (レポート用)
                if (phaseNum === 3) { // 対策実施（使用部門）
                    const problemItems = Object.keys(userSelections).filter(key => 
                        key.startsWith(`2_`) && userSelections[key] === '問題あり'
                    );
                    phaseItems = phaseItems.filter(item => problemItems.includes(item.linked_item_id));
                } else if (phaseNum === 5) { // 対策実施（メンテナンス部門）
                    const problemItems = Object.keys(userSelections).filter(key => 
                        key.startsWith(`4_`) && userSelections[key] === '問題あり'
                    );
                    phaseItems = phaseItems.filter(item => problemItems.includes(item.linked_item_id));
                } else if (phaseNum === 7) { // 試運転・正規運転
                    const problemItems = Object.keys(userSelections).filter(key => 
                        key.startsWith(`6_`) && userSelections[key] === '実施済み'
                    );
                    phaseItems = phaseItems.filter(item => problemItems.includes(item.linked_item_id));
                }

                const groupedItems = phaseItems.reduce((acc, item) => {
                    (acc[item.category] = acc[item.category] || []).push(item);
                    return acc;
                }, {});

                for (const category in groupedItems) {
                    let categoryContent = '';
                    groupedItems[category].forEach(item => {
                        const selection = userSelections[item.item_id];
                        if (selection) {
                            const resultText = selection === true ? "実施" : selection;
                            categoryContent += `<div class="report-item"><span>${item.item}</span><strong>${resultText}</strong></div>`;
                        }
                    });
                    if (categoryContent) {
                        hasContent = true;
                        sectionHtml += `<h4>${category}</h4>` + categoryContent;
                    }
                }
                sectionHtml += `</div>`;
                if(hasContent) {
                    reportHtml += sectionHtml;
                }
            });

            reportHtml += `</div>`;
            return reportHtml;
        }
    </script>
</body>
</html>