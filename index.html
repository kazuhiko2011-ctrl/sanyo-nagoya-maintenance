<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>チェックリストアプリ</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container mt-5">
        <!-- メインメニュー表示エリア -->
        <div id="menu-container" class="menu-container">
            <h1 class="text-center mb-4">チェックリスト選択</h1>
            <div id="menu-list" class="list-group"></div>
        </div>

        <!-- チェックリスト表示エリア (初期状態では非表示) -->
        <div id="checklist-app-container" class="d-none">
            <h1 id="checklist-title" class="text-center mb-4"></h1>
            <div id="checklist-container"></div>
            <div class="mt-3 text-center">
                <button id="prev-btn" class="btn btn-secondary">戻る</button>
                <button id="next-btn" class="btn btn-primary">次へ</button>
                <button id="print-btn" class="btn btn-info" disabled>結果を印刷/PDF化</button>
                <button id="exit-btn" class="btn btn-danger">終了</button>
            </div>
        </div>
    </div>
    <div id="printable-area" class="d-none"></div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
(function() {
    // --- 1. 固定設定 ---
    var SECRET_KEY = "93SYa4oyAeTbhKaC1Cj3hA";

    // --- 2. 汎用関数 ---
    function getQueryParam(param) {
        var href = window.location.href;
        var name = param.replace(/[\\[\\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
        var results = regex.exec(href);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // --- 3. アクセス制御 ---
    var currentKey = getQueryParam('key');
    if (currentKey !== SECRET_KEY) {
        document.body.innerHTML = '<div style="text-align: center; padding-top: 50px; font-family: sans-serif;"><h1>アクセス権がありません</h1><p>このページは指定された場所からのみアクセスできます。</p></div>';
        return;
    }

    // --- 4. アプリケーションのグローバル変数 ---
    var checklistData = [];
    var currentPhase = 1;
    var userSelections = {};
    var currentChecklistFile = '';
    var selectionKey = '';
    var phaseKey = '';
    var printEnabledKey = '';

    // --- 5. メインの初期化処理 ---
    $(document).ready(function() {
        initMenu();
        attachGlobalEventListeners();
    });

    // --- 6. メニュー機能 ---
    function initMenu() {
        // このロジックは将来的に `glob` を使うことで、自動的にファイルを見つけるように拡張できる
        var checklistFiles = [
            { file: 'DCS_Checklist.csv', title: 'DCS異常対応チェックリスト' },
            { file: 'Canned_Pump_Checklist.csv', title: '「キャンドポンプ（業務用）」異常対応チェックリスト' },
            { file: 'Gear_Pump_Checklist.csv', title: 'ギヤポンプ異常対応チェックリスト' },
            { file: 'Hugle_Pump_Checklist.csv', title: 'ヒューガルポンプ異常対応チェックリスト' },
            { file: 'Paper_Bag_Filling_Machine_Checklist.csv', title: '紙袋充填機チェックリスト' },
            { file: 'Magnet_Pump_Checklist.csv', title: '「マグネットポンプ」異常対応チェックリスト' }
        ];

        var menuList = $('#menu-list');
        menuList.empty();
        checklistFiles.forEach(function(item) {
            var link = $('<a href="#" class="list-group-item list-group-item-action"></a>');
            link.text(item.title);
            link.data('file', item.file);
            link.on('click', function(e) {
                e.preventDefault();
                loadChecklist($(this).data('file'), $(this).text());
            });
            menuList.append(link);
        });
    }

    // --- 7. チェックリストの読み込みと表示 ---
    function loadChecklist(fileName, title) {
        currentChecklistFile = fileName;
        selectionKey = 'userSelections_' + currentChecklistFile;
        phaseKey = 'currentPhase_' + currentChecklistFile;
        printEnabledKey = 'printEnabled_' + currentChecklistFile;

        fetch(fileName)
            .then(response => response.text())
            .then(csvText => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        checklistData = results.data;
                        $('#checklist-title').text(title);
                        $('#menu-container').addClass('d-none');
                        $('#checklist-app-container').removeClass('d-none');
                        initializeChecklist();
                    }
                });
            });
    }

    // --- 8. チェックリストの内部ロジック ---
    function initializeChecklist() {
        currentPhase = 1; // Reset to phase 1
        userSelections = {}; // Reset selections
        var storedSelections = sessionStorage.getItem(selectionKey);
        if (storedSelections) userSelections = JSON.parse(storedSelections);
        var storedPhase = sessionStorage.getItem(phaseKey);
        if (storedPhase) currentPhase = parseInt(storedPhase, 10);
        
        // Clear print enabled flag for new checklist
        sessionStorage.removeItem(printEnabledKey);

        renderPhase(currentPhase);
    }

    function renderPhase(phase) {
        var container = $('#checklist-container');
        container.empty();
        var phaseData = checklistData.filter(function(item) { return parseInt(item.phase) === phase; });
        if (phaseData.length === 0) {
            container.append('<p>このフェーズの項目はありません。</p>');
            updateNavigation();
            return;
        }
        var phaseTitle = phaseData[0].phase_title;
        container.append('<h2 class="phase-title">' + phaseTitle + '</h2>');

        var itemsToShow = phaseData;
        if (phase === 3 || phase === 5) {
            var linkedPhase = phase === 3 ? 2 : 4;
            var problemItemIds = [];
            for (var key in userSelections) {
                if (userSelections.hasOwnProperty(key)) {
                    var selection = userSelections[key];
                    if (parseInt(key.split('_')[0]) === linkedPhase && selection.value === '問題あり') {
                        problemItemIds.push(key);
                    }
                }
            }
            itemsToShow = phaseData.filter(function(item) { return problemItemIds.indexOf(item.linked_item_id) !== -1; });
        }

        if (itemsToShow.length === 0 && (phase === 3 || phase === 5)) {
            container.append('<p>前のフェーズで「問題あり」とされた項目はありません。次へ進んでください。</p>');
        } else {
            var groupedByCategory = itemsToShow.reduce(function(acc, item) {
                (acc[item.category] = acc[item.category] || []).push(item);
                return acc;
            }, {});
            for (var category in groupedByCategory) {
                container.append('<h4 class="category-title">' + category + '</h4>');
                groupedByCategory[category].forEach(function(item) { container.append(createItemHtml(item, phase)); });
            }
        }
        updateNavigation();
    }

    function createItemHtml(item, phase) {
        var itemKey = item.item_id;
        var savedSelection = userSelections[itemKey];
        var savedValue = savedSelection ? savedSelection.value : undefined;
        var inputs = '';
        if (item.type === 'checklist') {
            var isChecked = savedValue === 'checked';
            inputs = '<div class="form-check"><input type="checkbox" class="form-check-input" data-item-key="' + itemKey + '" ' + (isChecked ? 'checked' : '') + '></div>';
        } else {
            var options = (phase === 2 || phase === 4) ? ['問題なし', '問題あり'] : ['実施済み', '非該当'];
            var colors = (phase === 2 || phase === 4) ? ['success', 'danger'] : ['primary', 'secondary'];
            inputs += '<div class="btn-group btn-group-toggle" data-toggle="buttons">';
            for (var i = 0; i < options.length; i++) {
                var isActive = savedValue === options[i];
                inputs += '<label class="btn btn-outline-' + colors[i] + ' ' + (isActive ? 'active' : '') + '"><input type="radio" name="' + itemKey + '" value="' + options[i] + '" ' + (isActive ? 'checked' : '') + '> ' + options[i] + '</label>';
            }
            inputs += '</div>';
        }
        return '<div class="checklist-item-row"><label class="item-label">' + item.item + '</label><div>' + inputs + '</div></div>';
    }

    function updateNavigation() {
        var totalPhases = Math.max.apply(Math, checklistData.map(function(item) { return parseInt(item.phase); }));
        $('#prev-btn').toggle(currentPhase > 1);
        $('#next-btn').toggle(currentPhase < totalPhases);

        var phaseItems = checklistData.filter(function(item) { return parseInt(item.phase) === currentPhase; });
        var isNextEnabled = false;
        if (currentPhase === 1) {
            var detectionItems = phaseItems.filter(function(item) { return item.category === '異常検知'; });
            var stopItems = phaseItems.filter(function(item) { return item.category === '緊急停止措置'; });
            var oneDetectionChecked = detectionItems.some(function(item) { return userSelections[item.item_id]; });
            var allStopsChecked = stopItems.every(function(item) { return userSelections[item.item_id]; });
            isNextEnabled = oneDetectionChecked && allStopsChecked;
        } else {
            var itemsToCheck = phaseItems;
            if (currentPhase === 3 || currentPhase === 5) {
                var linkedPhase = currentPhase === 3 ? 2 : 4;
                var problemItemIds = [];
                for (var key in userSelections) {
                    if (userSelections.hasOwnProperty(key)) {
                        var selection = userSelections[key];
                        if (parseInt(key.split('_')[0]) === linkedPhase && selection.value === '問題あり') {
                            problemItemIds.push(key);
                        }
                    }
                }
                itemsToCheck = phaseItems.filter(function(item) { return problemItemIds.indexOf(item.linked_item_id) !== -1; });
            }
            isNextEnabled = itemsToCheck.length > 0 ? itemsToCheck.every(function(item) { return userSelections[item.item_id]; }) : true;
        }
        $('#next-btn').prop('disabled', !isNextEnabled);

        var printAlreadyEnabled = sessionStorage.getItem(printEnabledKey) === 'true';
        if (printAlreadyEnabled) {
            $('#print-btn').prop('disabled', false);
        } else {
            var phase3Items = checklistData.filter(function(item) { return parseInt(item.phase) === 3; });
            var allPhase3Answered = phase3Items.every(function(item) { return userSelections[item.item_id]; });
            if (currentPhase === 3 && allPhase3Answered) {
                $('#print-btn').prop('disabled', false);
                sessionStorage.setItem(printEnabledKey, 'true');
            } else {
                $('#print-btn').prop('disabled', true);
            }
        }
    }

    function attachGlobalEventListeners() {
        $('#checklist-container').on('change', 'input', function() {
            var key = this.name || $(this).data('item-key');
            var value = $(this).is(':checkbox') ? (this.checked ? 'checked' : 'unchecked') : this.value;
            userSelections[key] = { value: value, id: key, phase: currentPhase };
            sessionStorage.setItem(selectionKey, JSON.stringify(userSelections));
            updateNavigation();
        });

        $('#next-btn').click(function() {
            var totalPhases = Math.max.apply(Math, checklistData.map(function(item) { return parseInt(item.phase); }));
            if (currentPhase < totalPhases) {
                currentPhase++;
                sessionStorage.setItem(phaseKey, currentPhase.toString());
                renderPhase(currentPhase);
            }
        });

        $('#prev-btn').click(function() {
            if (currentPhase > 1) {
                currentPhase--;
                sessionStorage.setItem(phaseKey, currentPhase.toString());
                renderPhase(currentPhase);
            }
        });

        $('#exit-btn').click(function() {
            if (confirm('メインメニューに戻りますか？\n(入力内容は保存されます)')) {
                $('#checklist-app-container').addClass('d-none');
                $('#menu-container').removeClass('d-none');
            }
        });

        $('#print-btn').click(function() { /* ... Print logic ... */ });
    }
})();
    </script>
</body>
</html>